
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpportunityHub - Find Your Next Challenge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #ffd166;
            --danger: #ef476f;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles - Fixed for mobile */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        header.hidden {
            transform: translateY(-100%);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 1.5rem;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auth-buttons button {
            background-color: white;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-buttons button:hover {
            background-color: var(--light);
            transform: translateY(-2px);
        }
        
        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .auth-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .auth-tab.active {
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
            color: var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .auth-form button:hover {
            background-color: var(--secondary);
        }
        
        .auth-error {
            color: var(--danger);
            margin-top: 1rem;
            text-align: center;
            display: none;
        }
        
        /* Google Sign-In Button */
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            background-color: white;
            color: #757575;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        
        .google-signin-btn:hover {
            background-color: #f5f5f5;
        }
        
        .google-signin-btn img {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }
        
        /* Password Reset Link */
        .password-reset-link {
            text-align: center;
            margin-top: 15px;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
        }
        
        .password-reset-link:hover {
            text-decoration: underline;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(67, 97, 238, 0.9), rgba(58, 12, 163, 0.9)), url('https://images.unsplash.com/photo-1523240795612-9a054b0db644?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 4rem 0;
            text-align: center;
        }
        
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 2rem;
        }
        
        .search-bar {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
        }
        
       .search-bar input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 4px 0 0 4px;
            font-size: 1rem;
        }
        
        .search-bar button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* Filters Section */
        .filters {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin: -30px auto 30px;
            position: relative;
            max-width: 1000px;
            z-index: 10;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            background-color: var(--light);
        }
        
        /* Multi-select styles */
        .multiselect-container {
            position: relative;
        }
        
        .multiselect-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .multiselect-dropdown.show {
            display: block;
        }
        
        .multiselect-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .multiselect-option:hover {
            background-color: var(--light);
        }
        
        .multiselect-option input {
            margin-right: 8px;
            width: auto;
        }
        
        .multiselect-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .multiselect-tag {
            background-color: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        
        .multiselect-tag i {
            margin-left: 5px;
            cursor: pointer;
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .filter-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .apply-btn {
            background-color: var(--primary);
            color: white;
        }
        
        .reset-btn {
            background-color: var(--light-gray);
            color: var(--dark);
        }
        
        /* Opportunities Grid */
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin: 2rem 0;
        }
        
        .opportunity-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        
        .opportunity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        /* Opportunity badges - Updated for consistency */
        .opportunity-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            margin-right: 5px;
        }
        
        .type-badge {
            background-color: #e6f7ff;
            color: #0066cc;
        }
        
        .field-badge {
            background-color: #f0e6ff;
            color: #6600cc;
        }
        
        .format-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .format-online {
            background-color: #e6f7ff;
            color: #0066cc;
        }
        
        .format-onsite {
            background-color: #fff0e6;
            color: #cc4400;
        }
        
        .format-hybrid {
            background-color: #e6f7ed;
            color: #007a41;
        }
        
        .card-header h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .organization {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .detail {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .detail i {
            width: 24px;
            color: var(--primary);
            margin-right: 10px;
        }
        
        .deadline {
            color: var(--danger);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .deadline.urgent {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { color: var(--danger); }
            50% { color: #ff8fa3; }
            100% { color: var(--danger); }
        }
        
        .time-remaining {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            background-color: var(--light-gray);
        }
        
        .time-remaining.urgent {
            background-color: var(--danger);
            color: white;
        }
        
        .time-remaining.warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .time-remaining.normal {
            background-color: var(--success);
            color: white;
        }
        
        .card-footer {
            padding: 1rem 1.5rem;
            background-color: var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .save-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }
        
        .save-btn:hover, .save-btn.saved {
            color: var(--accent);
        }
        
        .apply-link, .details-btn {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            background-color: rgba(67, 97, 238, 0.1);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .apply-link:hover, .details-btn:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-between;
        }
        
        .card-actions .left-actions {
            display: flex;
            gap: 10px;
        }
        
        .card-actions .right-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
            margin: 2rem 0;
        }
        
        .dashboard-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .dashboard-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .dashboard-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
      .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        .dashboard-opportunities {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--light-gray);
        }
        
        /* Admin Panel */
        .admin-panel {
            display: none;
            margin: 2rem 0;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .admin-table th, .admin-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .admin-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .admin-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .admin-table tr:hover {
            background-color: #e9ecef;
        }
        
        .admin-actions-cell {
            display: flex;
            gap: 8px;
        }
        
        .admin-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .edit-btn {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .delete-btn {
            background-color: var(--danger);
            color: white;
        }
        
        /* Admin Modal */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .admin-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .admin-form-group {
            margin-bottom: 1.5rem;
        }
        
        .admin-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .admin-form-group input, .admin-form-group select, .admin-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .admin-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .admin-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 1.5rem;
        }
        
        .admin-form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: var(--light-gray);
            color: var(--dark);
        }
        
        .submit-btn {
            background-color: var(--primary);
            color: white;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-left: 4px solid var(--success);
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification i {
            color: var(--success);
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.error i {
            color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification.warning i {
            color: var(--warning);
        }
        
        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 3rem 0 2rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1.2rem;
            position: relative;
            padding-bottom: 10px;
        }
        
        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background-color: var(--accent);
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
            font-size: 0.9rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 1rem;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            nav ul li {
                margin: 5px;
            }
            
            .auth-buttons {
                margin-top: 1rem;
            }
            
            .hero h1 {
                font-size: 2.2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .admin-table {
                display: block;
                overflow-x: auto;
            }
            
            .opportunities-grid {
                grid-template-columns: 1fr;
            }
            
            .card-footer {
                flex-direction: column;
                align-items: stretch;
            }
            
            .card-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .card-actions .left-actions, .card-actions .right-actions {
                justify-content: space-between;
                width: 100%;
            }
            
            /* Mobile header behavior */
            header {
                padding: 0.5rem 0;
            }
            
            .logo {
                font-size: 1.4rem;
            }
            
            nav ul li {
                margin-left: 0.8rem;
            }
            
            .auth-buttons button {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 1.2rem;
            }
            
            nav ul li a {
                font-size: 0.9rem;
                padding: 4px 8px;
            }
            
            .auth-buttons button {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .hero h1 {
                font-size: 1.8rem;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-bar input {
                border-radius: 4px;
                margin-bottom: 10px;
            }
            
            .search-bar button {
                border-radius: 4px;
                padding: 12px;
            }
        }

        /* Enhanced Notification System */
        .notification-system {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: none;
            max-height: 500px;
            overflow: hidden;
        }

        .notification-system.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .notification-clear {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #f0f7ff;
            border-left: 3px solid var(--primary);
        }

        .notification-item.urgent {
            background-color: #fff5f5;
            border-left: 3px solid var(--danger);
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .notification-message {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #adb5bd;
        }

        .notification-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .notification-action-btn {
            background: none;
            border: 1px solid #dee2e6;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .empty-notifications {
            text-align: center;
            padding: 30px 20px;
            color: var(--gray);
        }

        .empty-notifications i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--light-gray);
        }

        /* Deadline Alert Modal */
        .deadline-alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .deadline-alert-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .deadline-alert-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .deadline-alert-header {
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .deadline-alert-header h3 {
            margin: 0;
            flex: 1;
        }

        .deadline-alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .deadline-alert-body {
            padding: 25px;
        }

        .deadline-alert-body p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .deadline-alert-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-primary, .btn-secondary, .btn-tertiary {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-tertiary {
            background: var(--light-gray);
            color: var(--dark);
        }

        /* Notification Bell in Header */
        .notification-bell {
            position: relative;
            margin-right: 15px;
            cursor: pointer;
        }

        .notification-bell i {
            font-size: 1.3rem;
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Notification Settings */
        .notification-settings {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999;
            display: none;
            max-width: 300px;
            width: 90%;
        }

        .notification-settings.show {
            display: block;
        }

        .notification-settings h4 {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Settings Icon */
        .settings-icon {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .settings-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Notification Preferences */
        .notification-preferences {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .preference-item {
            margin-bottom: 10px;
        }

        .preference-item label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .preference-item input {
            margin-right: 8px;
        }

        /* Details Modal */
        .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .details-modal.show {
            display: flex;
        }

        .details-content {
            background-color: white;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .details-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .details-header h2 {
            margin: 0;
            flex: 1;
            margin-right: 20px;
        }

        .details-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .details-body {
            padding: 1.5rem;
        }

        .details-section {
            margin-bottom: 1.5rem;
        }

        .details-section h3 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .details-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Duplicate Warning Modal */
        .duplicate-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .duplicate-warning-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .duplicate-warning-content h3 {
            color: var(--warning);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duplicate-warning-content h3 i {
            font-size: 1.5rem;
        }

        .existing-opportunity-info {
            background: #f8f9fa;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            border-left: 4px solid var(--warning);
        }

        .existing-opportunity-info h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .duplicate-warning-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .duplicate-warning-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-duplicate-btn {
            background: #6c757d;
            color: white;
        }

        .view-existing-btn {
            background: var(--primary);
            color: white;
        }

        .force-add-btn {
            background: var(--success);
            color: white;
        }

        /* Check Duplicates Button */
        .check-duplicates-btn {
            background: var(--warning);
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .check-duplicates-btn:hover {
            background: #e0a800;
        }
        
        /* No results message */
        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
            font-size: 1.1rem;
            grid-column: 1 / -1;
        }
        
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: var(--gray);
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .divider::before {
            margin-right: 10px;
        }
        
        .divider::after {
            margin-left: 10px;
        }

        /* CURATOR SYSTEM STYLES */
        .curator-profile {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
        }

        .curator-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 1.5rem 0;
        }

        .badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #b08d57);
        }

        .badge.silver {
            background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
        }

        .badge.gold {
            background: linear-gradient(135deg, #ffd700, #daa520);
        }

        /* Leaderboard Styles */
        .leaderboard-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .leaderboard-tab {
            padding: 10px 20px;
            background: var(--light-gray);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .leaderboard-tab.active {
            background: var(--primary);
            color: white;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .rank {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            width: 40px;
            text-align: center;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .curator-info {
            flex: 1;
            margin-left: 1rem;
        }

        .curator-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .curator-stats-small {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--gray);
        }

        .view-curator-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .view-curator-btn:hover {
            background: var(--secondary);
        }

        /* Navigation updates */
        .nav-curator {
            display: none;
        }

        /* Responsive updates */
        @media (max-width: 768px) {
            .curator-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .curator-info {
                margin-left: 0;
            }
            
            .curator-stats-small {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="mainHeader">
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                <span>OpportunityHub</span>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" class="nav-home">Home</a></li>
                    <li><a href="#" class="nav-opportunities">Opportunities</a></li>
                    <li><a href="#" class="nav-dashboard">Dashboard</a></li>
                    <li><a href="#" class="nav-curator">My Curator Profile</a></li>
                    <li><a href="#" class="nav-admin" style="display: none;">Admin</a></li>
                    <li class="notification-bell" id="notificationBell" style="display: none;">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </li>
                </ul>
            </nav>
            
            <div class="auth-buttons">
                <button id="loginBtn">Sign In</button>
                <button id="signupBtn">Sign Up</button>
                <button id="logoutBtn" style="display: none;">Logout</button>
                <button class="settings-icon" id="notificationSettingsBtn" style="display: none;">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="signup">Sign Up</div>
            </div>
            
            <div class="auth-form active" id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button id="doLogin">Login</button>
                <div class="password-reset-link" id="passwordResetLink">Forgot Password?</div>
                <div class="auth-error" id="loginError"></div>
                
                <div class="divider">or</div>
                <button class="google-signin-btn" id="googleSignIn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                    Sign in with Google
                </button>
            </div>
            
            <div class="auth-form" id="signupForm">
                <input type="text" id="signupName" placeholder="Full Name">
                <input type="email" id="signupEmail" placeholder="Email">
                <input type="password" id="signupPassword" placeholder="Password">
                <input type="password" id="signupConfirm" placeholder="Confirm Password">
                <button id="doSignup">Sign Up</button>
                <div class="auth-error" id="signupError"></div>
                
                <div class="divider">or</div>
                <button class="google-signin-btn" id="googleSignUp">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                    Sign up with Google
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hero Section -->
    <section class="hero" id="heroSection">
        <div class="container">
            <h1>Find Your Next Challenge</h1>
            <p>Discover internships, research opportunities, and summer programs to build your portfolio and boost your career</p>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search opportunities by keyword, field, or organization...">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </section>
    
    <!-- Main Content -->
    <main class="container">
        <!-- Curator Profile Section -->
        <div class="curator-profile" id="curatorProfile" style="display: none;">
            <h2>My Curator Profile</h2>
            <div class="curator-stats">
                <div class="stat-card">
                    <span class="stat-number" id="opportunitiesCreated">0</span>
                    <span class="stat-label">Opportunities Created</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalSaves">0</span>
                    <span class="stat-label">Total Saves by Students</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="uniqueSavers">0</span>
                    <span class="stat-label">Unique Students Reached</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="curatorRank">-</span>
                    <span class="stat-label">Leaderboard Rank</span>
                </div>
            </div>
            
            <h3>Your Badges</h3>
            <div class="badges-container" id="badgesContainer">
                <!-- Badges will be dynamically added here -->
            </div>
            
            <h3>Your Top Opportunities</h3>
            <div id="topOpportunitiesList">
                <!-- Top opportunities will be dynamically added here -->
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="leaderboard-section" id="leaderboardSection" style="display: none;">
            <div class="leaderboard-header">
                <h2>Top Curators</h2>
                <span id="leaderboardUpdateTime"></span>
            </div>
            
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" data-period="all">All Time</button>
                <button class="leaderboard-tab" data-period="month">This Month</button>
                <button class="leaderboard-tab" data-period="week">This Week</button>
            </div>
            
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be dynamically added here -->
            </div>
        </div>

        <!-- Filters Section -->
        <section class="filters" id="filtersSection">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="fieldInput">Field of Interest</label>
                    <div class="multiselect-container">
                        <input type="text" id="fieldInput" placeholder="Select fields..." readonly>
                        <div class="multiselect-dropdown" id="fieldDropdown">
                            <!-- Field options will be populated by JavaScript -->
                        </div>
                        <div class="multiselect-tags" id="fieldTags"></div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="typeInput">Opportunity Type</label>
                    <div class="multiselect-container">
                        <input type="text" id="typeInput" placeholder="Select types..." readonly>
                        <div class="multiselect-dropdown" id="typeDropdown">
                            <!-- Type options will be populated by JavaScript -->
                        </div>
                        <div class="multiselect-tags" id="typeTags"></div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="format">Format</label>
                    <select id="format">
                        <option value="">All Formats</option>
                        <option value="online">Online</option>
                        <option value="onsite">On-site</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label for="deadline">Deadline Within</label>
                    <select id="deadline">
                        <option value="">Any Time</option>
                        <option value="week">1 Week</option>
                        <option value="month">1 Month</option>
                        <option value="3months">3 Months</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="language">Language</label>
                    <select id="language">
                        <option value="">Any Language</option>
                        <option value="english">English</option>
                        <option value="russian">Russian</option>
                        <option value="uzbek">Uzbek</option>
                        <option value="english-russian">English/Russian</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="reset-btn" id="resetFilters">Reset Filters</button>
                <button class="apply-btn" id="applyFilters">Apply Filters</button>
            </div>
        </section>
        
        <!-- Opportunities Grid -->
        <h2 id="opportunitiesTitle">Featured Opportunities</h2>
        <div class="opportunities-grid" id="opportunitiesGrid">
            <!-- Opportunities will be loaded from Firebase -->
        </div>
        
        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <h2>My Dashboard</h2>
            
            <div class="dashboard-tabs">
                <div class="dashboard-tab active" data-tab="pending">Pending Opportunities</div>
                <div class="dashboard-tab" data-tab="completed">Completed</div>
            </div>
            
            <div class="dashboard-content active" id="pendingContent">
                <div class="dashboard-opportunities" id="pendingOpportunities">
                    <div class="empty-state">
                        <i class="far fa-bookmark"></i>
                        <h3>No pending opportunities</h3>
                        <p>Save opportunities to your dashboard to track them here</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-content" id="completedContent">
                <div class="dashboard-opportunities" id="completedOpportunities">
                    <div class="empty-state">
                        <i class="far fa-check-circle"></i>
                        <h3>No completed opportunities</h3>
                        <p>Mark opportunities as complete to track your achievements</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h2>Admin Panel</h2>
                <div class="admin-actions">
                    <button class="apply-btn" id="addOpportunityBtn">Add New Opportunity</button>
                    <button class="check-duplicates-btn" id="checkDuplicatesBtn">
                        <i class="fas fa-clone"></i> Check All Duplicates
                    </button>
                </div>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Organization</th>
                        <th>Type</th>
                        <th>Format</th>
                        <th>Deadline</th>
                        <th>Added By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminOpportunitiesList">
                    <!-- Admin opportunities will be loaded here -->
                </tbody>
            </table>
        </div>
    </main>
    
    <!-- Admin Modal -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-modal-content">
            <h2 id="adminModalTitle">Add New Opportunity</h2>
            
            <button class="check-duplicates-btn" id="checkDuplicateBtn">
                <i class="fas fa-search"></i> Check for Duplicates Before Submitting
            </button>
            
            <form id="adminOpportunityForm">
                <input type="hidden" id="opportunityId">
                
                <div class="admin-form-group">
                    <label for="adminTitle">Title *</label>
                    <input type="text" id="adminTitle" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminOrganization">Organization *</label>
                    <input type="text" id="adminOrganization" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminTypeInput">Type *</label>
                    <div class="multiselect-container">
                        <input type="text" id="adminTypeInput" placeholder="Select types..." readonly>
                        <div class="multiselect-dropdown" id="adminTypeDropdown">
                            <!-- Type options will be populated by JavaScript -->
                        </div>
                        <div class="multiselect-tags" id="adminTypeTags"></div>
                    </div>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminFieldInput">Field *</label>
                    <div class="multiselect-container">
                        <input type="text" id="adminFieldInput" placeholder="Select fields..." readonly>
                        <div class="multiselect-dropdown" id="adminFieldDropdown">
                            <!-- Field options will be populated by JavaScript -->
                        </div>
                        <div class="multiselect-tags" id="adminFieldTags"></div>
                    </div>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminFormat">Format *</label>
                    <select id="adminFormat" required>
                        <option value="">Select Format</option>
                        <option value="online">Online</option>
                        <option value="onsite">On-site</option>
                        <option value="hybrid">Hybrid</option>
                    </select>
                </div>
                
                <div class="admin-form-group" id="locationFieldGroup">
                    <label for="adminLocation">Location *</label>
                    <input type="text" id="adminLocation">
                </div>
                
                <div class="admin-form-group">
                    <label for="adminDescription">Description *</label>
                    <textarea id="adminDescription" required></textarea>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminDeadline">Deadline *</label>
                    <input type="date" id="adminDeadline" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminApplyLink">Application Link *</label>
                    <input type="url" id="adminApplyLink" required>
                </div>
                
                <div class="admin-form-group">
                    <label for="adminTimeCommitment">Time Commitment (Optional)</label>
                    <input type="text" id="adminTimeCommitment" placeholder="e.g., 20 hours per week">
                </div>
                
                <div class="admin-form-group">
                    <label for="adminDuration">Duration (Optional)</label>
                    <input type="text" id="adminDuration" placeholder="e.g., 3 months">
                </div>
                
                <div class="admin-form-group">
                    <label for="adminLanguage">Language (Optional)</label>
                    <select id="adminLanguage">
                        <option value="">Select Language</option>
                        <option value="english">English</option>
                        <option value="russian">Russian</option>
                        <option value="uzbek">Uzbek</option>
                        <option value="english-russian">English/Russian</option>
                    </select>
                </div>
                <div class="admin-form-group">
                    <label for="adminAgeRestrictions">Age Restrictions (Optional)</label>
                    <input type="text" id="adminAgeRestrictions" placeholder="e.g., Under 22, 18-25, 16+">
                </div>
                
                <div class="admin-form-actions">
                    <button type="button" class="cancel-btn" id="adminCancelBtn">Cancel</button>
                    <button type="submit" class="submit-btn">Save Opportunity</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div class="details-modal" id="detailsModal">
        <div class="details-content">
            <div class="details-header">
                <h2 id="detailsTitle">Opportunity Details</h2>
                <button class="details-close" id="detailsClose">&times;</button>
            </div>
            <div class="details-body">
                <div class="details-section">
                    <h3>Description</h3>
                    <p id="detailsDescription"></p>
                </div>
                <div class="details-section">
                    <h3>Organization</h3>
                    <p id="detailsOrganization"></p>
                </div>
                <div class="details-section">
                    <h3>Type</h3>
                    <p id="detailsType"></p>
                </div>
                <div class="details-section">
                    <h3>Field</h3>
                    <p id="detailsField"></p>
                </div>
                <div class="details-section">
                    <h3>Location</h3>
                    <p id="detailsLocation"></p>
                </div>
                <div class="details-section">
                    <h3>Deadline</h3>
                    <p id="detailsDeadline"></p>
                </div>
            <div class="details-section">
                <h3>Age Restrictions</h3>
                <p id="detailsAgeRestrictions">No age restrictions specified</p>
            </div>
                <div class="details-section">
                    <h3>Additional Information</h3>
                    <p id="detailsAdditionalInfo"></p>
                </div>
            </div>
            <div class="details-actions">
                <div class="left-actions">
                    <button class="save-btn" id="detailsSaveBtn">
                        <i class="far fa-bookmark"></i> Save to Dashboard
                    </button>
                </div>
                <div class="right-actions">
                    <a href="#" target="_blank" class="apply-link" id="detailsApplyLink">Apply Now</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i>
        <div class="notification-content">
            <h4>Notification</h4>
            <p>Operation completed successfully!</p>
        </div>
    </div>
    
    <!-- Enhanced Notification System -->
    <div class="notification-system" id="notificationSystem">
        <div class="notification-header">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <div>
                <button class="notification-clear" id="markAllRead">Mark All Read</button>
                <button class="notification-clear" id="clearAllNotifications">Clear All</button>
            </div>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be dynamically added here -->
        </div>
    </div>
    
    <!-- Deadline Alert Modal -->
    <div class="deadline-alert-modal" id="deadlineAlertModal">
        <div class="deadline-alert-content">
            <div class="deadline-alert-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Deadline Alert!</h3>
                <button class="deadline-alert-close" id="closeDeadlineAlert">&times;</button>
            </div>
            <div class="deadline-alert-body">
                <p id="deadlineAlertMessage"></p>
                <div class="deadline-alert-actions">
                    <button class="btn-primary" id="viewOpportunityBtn">View Opportunity</button>
                    <button class="btn-secondary" id="snoozeDeadlineBtn">Snooze (24h)</button>
                    <button class="btn-tertiary" id="dismissDeadlineBtn">Dismiss</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Settings Panel -->
    <div class="notification-settings" id="notificationSettings">
        <h4>Notification Settings <button class="settings-icon" id="closeSettings"><i class="fas fa-times"></i></button></h4>
        
        <div class="setting-item">
            <span>Browser Notifications</span>
            <label class="switch">
                <input type="checkbox" id="browserNotifications">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="setting-item">
            <span>Sound Notifications</span>
            <label class="switch">
                <input type="checkbox" id="soundNotifications">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="notification-preferences">
            <h5>Notification Preferences</h5>
            <div class="preference-item">
                <label>
                    <input type="checkbox" id="deadlineReminders" checked>
                    Deadline Reminders
                </label>
            </div>
            <div class="preference-item">
                <label>
                    <input type="checkbox" id="newOpportunities" checked>
                    New Opportunities
                </label>
            </div>
            <div class="preference-item">
                <label>
                    <input type="checkbox" id="applicationUpdates" checked>
                    Application Updates
                </label>
            </div>
        </div>
        
        <div class="setting-item">
            <span>Reminder Intervals (days before deadline)</span>
            <div>
                <label><input type="checkbox" name="reminderIntervals" value="7" checked> 7 days</label>
                <label><input type="checkbox" name="reminderIntervals" value="3" checked> 3 days</label>
                <label><input type="checkbox" name="reminderIntervals" value="1" checked> 1 day</label>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h3>About OpportunityHub</h3>
                <p>We connect high school students with meaningful opportunities to build their portfolios and gain real-world experience.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="#" class="footer-opportunities">Browse Opportunities</a></li>
                    <li><a href="#" class="footer-dashboard">My Dashboard</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Resources</h3>
                <ul class="footer-links">
                    <li><a href="#" class="footer-resources">Application Tips</a></li>
                    <li><a href="#" class="footer-resources">Interview Preparation</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Contact Us</h3>
                <ul class="footer-links">
                    <li><a href="mailto:opportunityhubcontacts@gmail.com"><i class="fas fa-envelope"></i>opportunityhubcontacts@gmail.com</a></li>
                </ul>
            </div>
        </div>
        
        <div class="container copyright">
            <p>&copy; 2025 OpportunityHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase App (core SDK is always required) -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged, 
        GoogleAuthProvider, 
        signInWithPopup,
        sendPasswordResetEmail,
        fetchSignInMethodsForEmail
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDEFumFatqFMn29D1x9f-_WWiVh2F_aVtQ",
        authDomain: "youthaxis-16bab.firebaseapp.com",
        projectId: "youthaxis-16bab",
        storageBucket: "youthaxis-16bab.firebasestorage.app",
        messagingSenderId: "287063568472",
        appId: "1:287063568472:web:9209a3a4a82407d63e9a2d",
        measurementId: "G-7M9QET4FLZ",
        databaseURL: "https://youthaxis-16bab-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // Global variables
    let allOpportunities = [];
    let filteredOpportunities = [];
    let userOpportunities = {
        pending: [],
        completed: []
    };
    let isAdminUser = false;
    let userOpportunitiesListener = null;
    let notificationManager = null;
    let currentOpportunityDetails = null;
    let lastScrollPosition = 0;

    // CURATOR SYSTEM VARIABLES
    let curatorStats = {
        opportunitiesCreated: 0,
        totalSaves: 0,
        uniqueSavers: 0,
        curatorRank: '-',
        badges: []
    };

    let leaderboardData = [];
    let userSaveStats = {}; // Track saves per opportunity

    // Enhanced field and type options - FIXED: Added "any" field option
    const FIELD_OPTIONS = {
        'any': 'Any Field', // Added this line to fix the issue
        'stem': 'STEM',
        'business': 'Business & Finance',
        'arts': 'Arts & Design',
        'social': 'Social Sciences',
        'health': 'Health & Medicine',
        'humanities': 'Humanities',
        'education': 'Education',
        'law': 'Law & Policy',
        'engineering': 'Engineering',
        'environment': 'Environmental Science',
        'journalism': 'Journalism & Media',
        'technology': 'Technology & Computer Science',
        'literature': 'Literature & Writing',
        'languages': 'Languages & Linguistics',
        'psychology': 'Psychology',
        'economics': 'Economics',
        'mathematics': 'Mathematics',
        'physics': 'Physics',
        'chemistry': 'Chemistry',
        'biology': 'Biology'
    };

    const TYPE_OPTIONS = {
        'internship': 'Internship',
        'research': 'Research',
        'summer': 'Summer Program',
        'volunteer': 'Volunteer',
        'scholarship': 'Scholarship',
        'competition': 'Competition',
        'conference': 'Conference',
        'fellowship': 'Fellowship',
        'workshop': 'Workshop',
        'grant': 'Grant',
        'award': 'Award',
        'exchange': 'Exchange Program',
        'mentorship': 'Mentorship Program',
        'training': 'Training Program'
    };
    const ADMIN_ROLES = {
  SUPER_ADMIN: 'super-admin',
  ADMIN: 'admin'
};

    // Utility functions
    function getOpportunityTypeText(type) {
        if (!type) return 'Not specified';
        
        if (Array.isArray(type)) {
            return type.map(t => TYPE_OPTIONS[t] || t).join(', ');
        }
        return TYPE_OPTIONS[type] || type;
    }

    function getFieldText(field) {
        if (!field) return 'Any Field';
        
        if (Array.isArray(field)) {
            // If array contains "any", show "Any Field"
            if (field.includes('any')) {
                return 'Any Field';
            }
            return field.map(f => FIELD_OPTIONS[f] || f).join(', ');
        }
        
        // If single field is "any", show "Any Field"
        if (field === 'any') {
            return 'Any Field';
        }
        
        return FIELD_OPTIONS[field] || field;
    }

    function getFormatBadge(format) {
        switch(format) {
            case 'online': return '<span class="format-badge format-online">Online</span>';
            case 'onsite': return '<span class="format-badge format-onsite">On-site</span>';
            case 'hybrid': return '<span class="format-badge format-hybrid">Hybrid</span>';
            default: return '';
        }
    }

    function getFormatText(format) {
        switch(format) {
            case 'online': return 'Online';
            case 'onsite': return 'On-site';
            case 'hybrid': return 'Hybrid';
            default: return format || 'Not specified';
        }
    }

function formatDate(dateString) {
    if (!dateString) return 'No deadline';
    
    try {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('en-US', options);
    } catch (e) {
        return 'Invalid date';
    }
}

    function calculateTimeRemaining(deadline) {
        if (!deadline) return { text: 'No deadline', class: 'normal' };
        
        try {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { text: 'Expired', class: 'expired' };
            } else if (diffDays === 0) {
                return { text: 'Today', class: 'urgent' };
            } else if (diffDays === 1) {
                return { text: '1 day', class: 'urgent' };
            } else if (diffDays < 7) {
                return { text: `${diffDays} days`, class: 'urgent' };
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                const days = diffDays % 7;
                let text = `${weeks} week${weeks > 1 ? 's' : ''}`;
                if (days > 0) {
                    text += `, ${days} day${days > 1 ? 's' : ''}`;
                }
                return { text, class: 'warning' };
            } else {
                const months = Math.floor(diffDays / 30);
                const days = diffDays % 30;
                let text = `${months} month${months > 1 ? 's' : ''}`;
                if (days > 0) {
                    text += `, ${days} day${days > 1 ? 's' : ''}`;
                }
                return { text, class: 'normal' };
            }
        } catch (e) {
            return { text: 'Invalid date', class: 'normal' };
        }
    }

    function isOpportunityExpired(deadline) {
        if (!deadline) return false;
        
        try {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            return deadlineDate < today;
        } catch (e) {
            return false;
        }
    }

    function isDeadlineUrgent(deadline) {
        if (!deadline) return false;
        
        try {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays >= 0;
        } catch (e) {
            return false;
        }
    }

    // CURATOR SYSTEM FUNCTIONS
    function initCuratorSystem() {
        trackOpportunitySaves();
        loadCuratorStats();
        loadLeaderboard();
        
        // Update curator nav visibility
        const user = auth.currentUser;
        if (user) {
            document.querySelector('.nav-curator').style.display = 'list-item';
        }
    }

    // Track when opportunities are saved
    function trackOpportunitySaves() {
        const userOppRef = ref(database, 'userOpportunities');
        onValue(userOppRef, (snapshot) => {
            const data = snapshot.val();
            userSaveStats = {};
            
            if (data) {
                // Count saves per opportunity
                for (const userId in data) {
                    for (const oppId in data[userId]) {
                        if (!userSaveStats[oppId]) {
                            userSaveStats[oppId] = new Set();
                        }
                        userSaveStats[oppId].add(userId);
                    }
                }
                
                // Update curator stats if user is logged in
                const user = auth.currentUser;
                if (user) {
                    loadCuratorStats();
                }
            }
        });
    }

    // Load curator statistics for current user
    function loadCuratorStats() {
        const user = auth.currentUser;
        if (!user) return;

        // Count opportunities created by user
        const userOpportunities = allOpportunities.filter(opp => opp.addedBy === user.uid);
        curatorStats.opportunitiesCreated = userOpportunities.length;

        // Calculate total saves and unique savers
        let totalSaves = 0;
        let uniqueSavers = new Set();
        
        userOpportunities.forEach(opp => {
            if (userSaveStats[opp.id]) {
                totalSaves += userSaveStats[opp.id].size;
                userSaveStats[opp.id].forEach(saverId => uniqueSavers.add(saverId));
            }
        });

        curatorStats.totalSaves = totalSaves;
        curatorStats.uniqueSavers = uniqueSavers.size;

        // Calculate rank
        calculateUserRank(user.uid);

        // Update badges
        updateBadges();

        // Update UI
        updateCuratorProfileUI();
    }

    // Calculate user's rank in leaderboard
    function calculateUserRank(userId) {
        const userStats = leaderboardData.find(user => user.id === userId);
        if (userStats) {
            curatorStats.curatorRank = userStats.rank;
        } else {
            curatorStats.curatorRank = '-';
        }
    }

    // Update badges based on achievements
    function updateBadges() {
        const badges = [];
        
        // Bronze Curator - Created 10+ opportunities
        if (curatorStats.opportunitiesCreated >= 10) {
            badges.push({ name: 'Bronze Curator', level: 'bronze', icon: '' });
        }
        
        // Silver Curator - Created 25+ opportunities and 50+ saves
        if (curatorStats.opportunitiesCreated >= 25 && curatorStats.totalSaves >= 50) {
            badges.push({ name: 'Silver Curator', level: 'silver', icon: '' });
        }
        
        // Gold Curator - Created 50+ opportunities and 200+ saves
        if (curatorStats.opportunitiesCreated >= 50 && curatorStats.totalSaves >= 200) {
            badges.push({ name: 'Gold Curator', level: 'gold', icon: '' });
        }
        
        // Community Builder - Reached 100+ unique students
        if (curatorStats.uniqueSavers >= 100) {
            badges.push({ name: 'Community Builder', level: 'gold', icon: '' });
        }
        
        // Rising Star - Top 10 in leaderboard
        if (curatorStats.curatorRank <= 10 && curatorStats.curatorRank !== '-') {
            badges.push({ name: 'Rising Star', level: 'silver', icon: '' });
        }
        
        curatorStats.badges = badges;
    }

    // Update curator profile UI
    function updateCuratorProfileUI() {
        document.getElementById('opportunitiesCreated').textContent = curatorStats.opportunitiesCreated;
        document.getElementById('totalSaves').textContent = curatorStats.totalSaves;
        document.getElementById('uniqueSavers').textContent = curatorStats.uniqueSavers;
        document.getElementById('curatorRank').textContent = curatorStats.curatorRank;

        // Update badges
        const badgesContainer = document.getElementById('badgesContainer');
        badgesContainer.innerHTML = '';
        
        curatorStats.badges.forEach(badge => {
            const badgeElement = document.createElement('div');
            badgeElement.className = `badge ${badge.level}`;
            badgeElement.innerHTML = `
                ${badge.icon} ${badge.name}
            `;
            badgesContainer.appendChild(badgeElement);
        });

        // Update top opportunities
        updateTopOpportunities();
    }

    // Show user's top opportunities by saves
    function updateTopOpportunities() {
        const user = auth.currentUser;
        if (!user) return;

        const userOpportunities = allOpportunities.filter(opp => opp.addedBy === user.uid);
        
        // Sort by number of saves (descending)
        userOpportunities.sort((a, b) => {
            const savesA = userSaveStats[a.id] ? userSaveStats[a.id].size : 0;
            const savesB = userSaveStats[b.id] ? userSaveStats[b.id].size : 0;
            return savesB - savesA;
        });

        const topOpportunitiesList = document.getElementById('topOpportunitiesList');
        topOpportunitiesList.innerHTML = '';

        // Show top 5 opportunities
        const topOpps = userOpportunities.slice(0, 5);
        topOpps.forEach(opp => {
            const saves = userSaveStats[opp.id] ? userSaveStats[opp.id].size : 0;
            const oppElement = document.createElement('div');
            oppElement.className = 'opportunity-card';
            oppElement.innerHTML = `
                <div class="card-header">
                    <h3>${opp.title}</h3>
                    <p class="organization">${opp.organization}</p>
                </div>
                <div class="card-body">
                    <p>Saved by <strong>${saves}</strong> students</p>
                </div>
            `;
            topOpportunitiesList.appendChild(oppElement);
        });
    }

    // Load and display leaderboard
    function loadLeaderboard() {
        // Group opportunities by creator and calculate stats
        const creatorStats = {};
        
        allOpportunities.forEach(opp => {
            if (!creatorStats[opp.addedBy]) {
                creatorStats[opp.addedBy] = {
                    id: opp.addedBy,
                    name: opp.addedByName || 'Unknown Curator',
                    opportunities: 0,
                    totalSaves: 0,
                    uniqueSavers: new Set()
                };
            }
            
            creatorStats[opp.addedBy].opportunities++;
            
            if (userSaveStats[opp.id]) {
                creatorStats[opp.addedBy].totalSaves += userSaveStats[opp.id].size;
                userSaveStats[opp.id].forEach(saverId => {
                    creatorStats[opp.addedBy].uniqueSavers.add(saverId);
                });
            }
        });

        // Convert to array and calculate score
        leaderboardData = Object.values(creatorStats).map(creator => {
            const score = creator.opportunities * 2 + creator.totalSaves + creator.uniqueSavers.size * 3;
            return {
                ...creator,
                uniqueSavers: creator.uniqueSavers.size,
                score: score
            };
        });

        // Sort by score (descending)
        leaderboardData.sort((a, b) => b.score - a.score);

        // Add ranks
        leaderboardData.forEach((creator, index) => {
            creator.rank = index + 1;
        });

        updateLeaderboardUI();
    }

    // Update leaderboard UI
    function updateLeaderboardUI() {
        const leaderboardList = document.getElementById('leaderboardList');
        leaderboardList.innerHTML = '';

        // Show top 20 curators
        const topCurators = leaderboardData.slice(0, 20);
        
        topCurators.forEach(creator => {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            item.innerHTML = `
                <div class="rank rank-${creator.rank}">${creator.rank}</div>
                <div class="curator-info">
                    <div class="curator-name">${creator.name}</div>
                    <div class="curator-stats-small">
                        <span>${creator.opportunities} opportunities</span>
                        <span>${creator.totalSaves} saves</span>
                        <span>${creator.uniqueSavers} students reached</span>
                    </div>
                </div>
                <button class="view-curator-btn" data-userid="${creator.id}">
                    View Profile
                </button>
            `;
            leaderboardList.appendChild(item);
        });

        // Update timestamp
        document.getElementById('leaderboardUpdateTime').textContent = 
            `Last updated: ${new Date().toLocaleTimeString()}`;
    }

    // Show curator profile
    function showCuratorProfile() {
        document.getElementById('curatorProfile').style.display = 'block';
        document.getElementById('leaderboardSection').style.display = 'block';
        
        // Hide other sections
        document.getElementById('heroSection').style.display = 'none';
        document.getElementById('filtersSection').style.display = 'none';
        document.getElementById('opportunitiesTitle').style.display = 'none';
        document.getElementById('opportunitiesGrid').style.display = 'none';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        
        // Load fresh data
        loadCuratorStats();
        loadLeaderboard();
    }

    function showOpportunityDetails(opportunity) {
        const detailsModal = document.getElementById('detailsModal');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsDescription = document.getElementById('detailsDescription');
        const detailsOrganization = document.getElementById('detailsOrganization');
        const detailsType = document.getElementById('detailsType');
        const detailsField = document.getElementById('detailsField');
        const detailsLocation = document.getElementById('detailsLocation');
        const detailsDeadline = document.getElementById('detailsDeadline');
        const detailsAdditionalInfo = document.getElementById('detailsAdditionalInfo');
        const detailsApplyLink = document.getElementById('detailsApplyLink');
        const detailsSaveBtn = document.getElementById('detailsSaveBtn');
        
        if (!detailsModal) return;
        
        // Set opportunity details with fallbacks for missing data
        detailsTitle.textContent = opportunity.title || 'No title';
        detailsDescription.textContent = opportunity.description || 'No description available';
        detailsOrganization.textContent = opportunity.organization || 'Unknown organization';
        detailsType.textContent = getOpportunityTypeText(opportunity.type);
        detailsField.textContent = getFieldText(opportunity.field);
        
        // Set location based on format
        if (opportunity.format === 'online') {
            detailsLocation.textContent = 'Online';
        } else {
            detailsLocation.textContent = opportunity.location || 'Not specified';
        }
        
        detailsDeadline.textContent = formatDate(opportunity.deadline);
        detailsApplyLink.href = opportunity.applyLink || '#';
        
        // Build additional info section
let additionalInfo = '';
if (opportunity.format) {
    additionalInfo += `<p><strong>Format:</strong> ${getFormatText(opportunity.format)}</p>`;
}
if (opportunity.timeCommitment) {
    additionalInfo += `<p><strong>Time Commitment:</strong> ${opportunity.timeCommitment}</p>`;
}
if (opportunity.duration) {
    additionalInfo += `<p><strong>Duration:</strong> ${opportunity.duration}</p>`;
}
if (opportunity.language) {
    additionalInfo += `<p><strong>Language:</strong> ${opportunity.language}</p>`;
}
if (opportunity.ageRestrictions) { // Add this block
    additionalInfo += `<p><strong>Age Restrictions:</strong> ${opportunity.ageRestrictions}</p>`;
}
if (opportunity.addedByName) {
    additionalInfo += `<p><strong>Added by:</strong> ${opportunity.addedByName}</p>`;
}
document.getElementById('detailsAgeRestrictions').textContent = opportunity.ageRestrictions || 'No age restrictions specified';
detailsAdditionalInfo.innerHTML = additionalInfo || '<p>No additional information provided.</p>';
        
        // Check if opportunity is already saved
        const isSaved = userOpportunities.pending.some(item => item.id === opportunity.id) || 
                       userOpportunities.completed.some(item => item.id === opportunity.id);
        
        // Update save button
        if (isSaved) {
            detailsSaveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Remove from Dashboard';
            detailsSaveBtn.classList.add('saved');
        } else {
            detailsSaveBtn.innerHTML = '<i class="far fa-bookmark"></i> Save to Dashboard';
            detailsSaveBtn.classList.remove('saved');
        }
        
        // Store current opportunity for save button functionality
        currentOpportunityDetails = opportunity;
        
        // Show modal
        detailsModal.classList.add('show');
    }

    function closeOpportunityDetails() {
        const detailsModal = document.getElementById('detailsModal');
        if (detailsModal) {
            detailsModal.classList.remove('show');
        }
    }

    // Global notification function
    function showNotification(message, type = 'success') {
        // First try to use the notification manager if available
        if (notificationManager && notificationManager.addNotification) {
            const notificationId = `manual-${Date.now()}`;
            const notification = {
                id: notificationId,
                title: type === 'error' ? 'Error' : type === 'warning' ? 'Warning' : 'Success',
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false,
                urgent: type === 'error',
                category: 'system'
            };
            notificationManager.addNotification(notification);
            
            // ALSO show popup notification
            showPopupNotification(message, type);
            return;
        }
        
        // Fallback to the simple notification system
        showPopupNotification(message, type);
    }

    // Show popup notification
    function showPopupNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        const notificationContent = notification.querySelector('.notification-content');
        
        // Update notification style based on type
        notification.className = 'notification';
        if (type === 'error') {
            notification.classList.add('error');
        } else if (type === 'warning') {
            notification.classList.add('warning');
        }
        
        if (message) {
            notificationContent.innerHTML = `
                <h4>${type === 'error' ? 'Error' : type === 'warning' ? 'Warning' : 'Success'}</h4>
                <p>${message}</p>
            `;
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Enhanced Notification System
    class NotificationManager {
        constructor() {
            this.notifications = [];
            this.settings = {
                browserNotifications: true,
                soundEnabled: true,
                reminderIntervals: [7, 3, 1], // days before deadline to remind
                deadlineReminders: true,
                newOpportunities: true,
                applicationUpdates: true
            };
            this.deadlineCheckInterval = null;
            this.init();
        }

        init() {
            this.loadSettings();
            this.setupEventListeners();
            this.startDeadlineChecker();
            this.loadNotifications();
            
            // Request notification permission
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        }

        cleanup() {
            if (this.deadlineCheckInterval) {
                clearInterval(this.deadlineCheckInterval);
                this.deadlineCheckInterval = null;
            }
            
            this.hideNotificationPanel();
            this.hideSettingsPanel();
            this.hideDeadlineAlert();
        }

        setupEventListeners() {
            // Notification bell
            const notificationBell = document.getElementById('notificationBell');
            if (notificationBell) {
                notificationBell.addEventListener('click', () => this.toggleNotificationPanel());
            }

            // Mark all as read button
            const markAllReadBtn = document.getElementById('markAllRead');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', () => this.markAllAsRead());
            }

            // Clear all notifications
            const clearAllBtn = document.getElementById('clearAllNotifications');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => this.clearAllNotifications());
            }

            // Deadline alert modal buttons
            const closeAlertBtn = document.getElementById('closeDeadlineAlert');
            if (closeAlertBtn) {
                closeAlertBtn.addEventListener('click', () => this.hideDeadlineAlert());
            }

            const viewOpportunityBtn = document.getElementById('viewOpportunityBtn');
            if (viewOpportunityBtn) {
                viewOpportunityBtn.addEventListener('click', () => this.viewOpportunity());
            }

            const snoozeDeadlineBtn = document.getElementById('snoozeDeadlineBtn');
            if (snoozeDeadlineBtn) {
                snoozeDeadlineBtn.addEventListener('click', () => this.snoozeDeadline());
            }

            const dismissDeadlineBtn = document.getElementById('dismissDeadlineBtn');
            if (dismissDeadlineBtn) {
                dismissDeadlineBtn.addEventListener('click', () => this.dismissDeadline());
            }

            // Notification settings
            const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
            if (notificationSettingsBtn) {
                notificationSettingsBtn.addEventListener('click', () => this.toggleSettingsPanel());
            }

            const closeSettingsBtn = document.getElementById('closeSettings');
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', () => this.hideSettingsPanel());
            }

            // Settings checkboxes
            const browserNotificationsCheckbox = document.getElementById('browserNotifications');
            if (browserNotificationsCheckbox) {
                browserNotificationsCheckbox.checked = this.settings.browserNotifications;
                browserNotificationsCheckbox.addEventListener('change', (e) => {
                    this.settings.browserNotifications = e.target.checked;
                    this.saveSettings();
                });
            }

            const soundNotificationsCheckbox = document.getElementById('soundNotifications');
            if (soundNotificationsCheckbox) {
                soundNotificationsCheckbox.checked = this.settings.soundEnabled;
                soundNotificationsCheckbox.addEventListener('change', (e) => {
                    this.settings.soundEnabled = e.target.checked;
                    this.saveSettings();
                });
            }

            // Notification preferences
            const deadlineRemindersCheckbox = document.getElementById('deadlineReminders');
            if (deadlineRemindersCheckbox) {
                deadlineRemindersCheckbox.checked = this.settings.deadlineReminders;
                deadlineRemindersCheckbox.addEventListener('change', (e) => {
                    this.settings.deadlineReminders = e.target.checked;
                    this.saveSettings();
                });
            }

            const newOpportunitiesCheckbox = document.getElementById('newOpportunities');
            if (newOpportunitiesCheckbox) {
                newOpportunitiesCheckbox.checked = this.settings.newOpportunities;
                newOpportunitiesCheckbox.addEventListener('change', (e) => {
                    this.settings.newOpportunities = e.target.checked;
                    this.saveSettings();
                });
            }

            const applicationUpdatesCheckbox = document.getElementById('applicationUpdates');
            if (applicationUpdatesCheckbox) {
                applicationUpdatesCheckbox.checked = this.settings.applicationUpdates;
                applicationUpdatesCheckbox.addEventListener('change', (e) => {
                    this.settings.applicationUpdates = e.target.checked;
                    this.saveSettings();
                });
            }

            // Reminder intervals
            const reminderIntervalsCheckboxes = document.querySelectorAll('input[name="reminderIntervals"]');
            reminderIntervalsCheckboxes.forEach(checkbox => {
                checkbox.checked = this.settings.reminderIntervals.includes(parseInt(checkbox.value));
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.settings.reminderIntervals.push(parseInt(e.target.value));
                    } else {
                        this.settings.reminderIntervals = this.settings.reminderIntervals.filter(
                            interval => interval !== parseInt(e.target.value)
                        );
                    }
                    this.saveSettings();
                });
            });

            // Close notification panel when clicking outside
            document.addEventListener('click', (e) => {
                const notificationSystem = document.getElementById('notificationSystem');
                const notificationBell = document.getElementById('notificationBell');
                
                if (notificationSystem && notificationSystem.classList.contains('show') &&
                    !notificationSystem.contains(e.target) && 
                    !notificationBell.contains(e.target)) {
                    this.hideNotificationPanel();
                }

                // Close settings panel when clicking outside
                const notificationSettings = document.getElementById('notificationSettings');
                const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
                
                if (notificationSettings && notificationSettings.classList.contains('show') &&
                    !notificationSettings.contains(e.target) && 
                    !notificationSettingsBtn.contains(e.target)) {
                    this.hideSettingsPanel();
                }
            });
        }

        // Load notification settings from localStorage
        loadSettings() {
            const user = auth.currentUser;
            const key = user ? `notificationSettings_${user.uid}` : 'notificationSettings_guest';
            const savedSettings = localStorage.getItem(key);
            
            if (savedSettings) {
                this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
            }
        }

        // Save notification settings to localStorage
        saveSettings() {
            const user = auth.currentUser;
            const key = user ? `notificationSettings_${user.uid}` : 'notificationSettings_guest';
            localStorage.setItem(key, JSON.stringify(this.settings));
        }

        // Check for approaching deadlines
        startDeadlineChecker() {
            // Check every hour
            this.deadlineCheckInterval = setInterval(() => {
                this.checkApproachingDeadlines();
            }, 60 * 60 * 1000);

            // Initial check
            setTimeout(() => {
                this.checkApproachingDeadlines();
            }, 2000);
        }

        async checkApproachingDeadlines() {
            const user = auth.currentUser;
            if (!user || !allOpportunities || allOpportunities.length === 0) return;

            try {
                const userOppRef = ref(database, `userOpportunities/${user.uid}`);
                const snapshot = await get(userOppRef);
                
                if (!snapshot.exists()) return;

                const userOpportunities = snapshot.val();
                const now = new Date();
                const opportunitiesToNotify = [];

                for (const [oppId, userOpp] of Object.entries(userOpportunities)) {
                    if (userOpp.status !== 'pending') continue;

                    const opportunity = allOpportunities.find(opp => opp.id === oppId);
                    if (!opportunity || !opportunity.deadline) continue;

                    const deadline = new Date(opportunity.deadline);
                    const daysUntilDeadline = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));

                    // Check if we should notify based on reminder intervals
                    if (this.settings.reminderIntervals.includes(daysUntilDeadline) && daysUntilDeadline > 0) {
                        opportunitiesToNotify.push({
                            opportunity,
                            daysUntilDeadline,
                            userOpp
                        });
                    }

                    // Notify if deadline is today
                    if (daysUntilDeadline === 0) {
                        opportunitiesToNotify.push({
                            opportunity,
                            daysUntilDeadline: 0,
                            userOpp,
                            isToday: true
                        });
                    }

                    // Notify if deadline has passed but not completed
                    if (daysUntilDeadline < 0 && userOpp.status === 'pending') {
                        opportunitiesToNotify.push({
                            opportunity,
                            daysUntilDeadline,
                            userOpp,
                            isOverdue: true
                        });
                    }
                }

                // Create notifications for each opportunity
                opportunitiesToNotify.forEach(opp => {
                    this.createDeadlineNotification(opp);
                });

            } catch (error) {
                console.error('Error checking deadlines:', error);
            }
        }

        createDeadlineNotification(opportunityInfo) {
            const { opportunity, daysUntilDeadline, isToday, isOverdue } = opportunityInfo;
            const notificationId = `deadline-${opportunity.id}-${daysUntilDeadline}`;

            // Check if we already notified for this deadline
            if (this.hasBeenNotified(notificationId)) return;

            let title, message, type, urgent = false;

            if (isOverdue) {
                title = 'Deadline Passed!';
                message = `The deadline for "${opportunity.title}" has passed. Consider marking it as complete or removing it.`;
                type = 'error';
                urgent = true;
            } else if (isToday) {
                title = 'Deadline Today!';
                message = `"${opportunity.title}" application is due today!`;
                type = 'error';
                urgent = true;
            } else {
                title = 'Deadline Approaching';
                message = `"${opportunity.title}" application is due in ${daysUntilDeadline} day${daysUntilDeadline !== 1 ? 's' : ''}.`;
                type = 'warning';
                urgent = daysUntilDeadline <= 3;
            }

            const notification = {
                id: notificationId,
                title,
                message,
                type,
                opportunityId: opportunity.id,
                timestamp: new Date().toISOString(),
                read: false,
                urgent,
                category: 'deadline'
            };

            this.addNotification(notification);
            this.showBrowserNotification(notification);
            
            if (urgent) {
                this.showUrgentDeadlineAlert(notification, opportunity);
            }

            // Mark as notified in localStorage
            this.markAsNotified(notificationId);
        }

        addNotification(notification) {
            this.notifications.unshift(notification);
            this.saveNotifications();
            this.updateNotificationUI();
            
            // Show popup notification for urgent or new notifications
            if (notification.urgent || notification.category === 'system') {
                showPopupNotification(notification.message, notification.type);
            }
        }

        saveNotifications() {
            const user = auth.currentUser;
            if (user) {
                localStorage.setItem(`notifications_${user.uid}`, JSON.stringify(this.notifications));
            } else {
                localStorage.setItem('notifications_guest', JSON.stringify(this.notifications));
            }
        }

        loadNotifications() {
            const user = auth.currentUser;
            const key = user ? `notifications_${user.uid}` : 'notifications_guest';
            const savedNotifications = localStorage.getItem(key);
            
            if (savedNotifications) {
                this.notifications = JSON.parse(savedNotifications);
                this.updateNotificationUI();
            }
        }

        updateNotificationUI() {
            const notificationBell = document.getElementById('notificationBell');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationList = document.getElementById('notificationList');

            if (!notificationBell || !notificationBadge || !notificationList) return;

            const unreadCount = this.notifications.filter(n => !n.read).length;

            // Update badge
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                notificationBadge.style.display = 'block';
                if (notificationBell) notificationBell.style.display = 'list-item';
            } else {
                notificationBadge.style.display = 'none';
            }

            // Update notification list
            notificationList.innerHTML = '';

            if (this.notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            this.notifications.forEach(notification => {
                const notificationElement = this.createNotificationElement(notification);
                notificationList.appendChild(notificationElement);
            });
        }

        createNotificationElement(notification) {
            const element = document.createElement('div');
            element.className = `notification-item ${notification.urgent ? 'urgent' : ''} ${!notification.read ? 'unread' : ''}`;
            element.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${this.getNotificationIcon(notification.type)}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${this.formatTime(notification.timestamp)}</div>
                    <div class="notification-actions">
                        ${!notification.read ? 
                            `<button class="notification-action-btn mark-read" data-id="${notification.id}">Mark Read</button>` : 
                            `<button class="notification-action-btn mark-unread" data-id="${notification.id}">Mark Unread</button>`
                        }
                        <button class="notification-action-btn delete-notification" data-id="${notification.id}">Delete</button>
                    </div>
                </div>
            `;

            // Add event listeners
            element.addEventListener('click', (e) => {
                if (!e.target.classList.contains('notification-action-btn')) {
                    this.handleNotificationClick(notification);
                }
            });

            const markReadBtn = element.querySelector('.mark-read, .mark-unread');
            if (markReadBtn) {
                markReadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleReadStatus(notification.id);
                });
            }

            const deleteBtn = element.querySelector('.delete-notification');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteNotification(notification.id);
                });
            }

            return element;
        }

        getNotificationIcon(type) {
            switch (type) {
                case 'error': return 'exclamation-triangle';
                case 'warning': return 'exclamation-circle';
                case 'success': return 'check-circle';
                default: return 'info-circle';
            }
        }

        formatTime(timestamp) {
            const now = new Date();
            const notificationTime = new Date(timestamp);
            const diffMs = now - notificationTime;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return notificationTime.toLocaleDateString();
        }

        handleNotificationClick(notification) {
            this.markAsRead(notification.id);
            
            if (notification.opportunityId) {
                // Find and show the opportunity
                const opportunity = allOpportunities.find(opp => opp.id === notification.opportunityId);
                if (opportunity) {
                    showOpportunityDetails(opportunity);
                }
            }
            
            this.hideNotificationPanel();
        }

        markAsRead(notificationId) {
            const notification = this.notifications.find(n => n.id === notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                this.saveNotifications();
                this.updateNotificationUI();
            }
        }

        markAllAsRead() {
            this.notifications.forEach(notification => {
                notification.read = true;
            });
            this.saveNotifications();
            this.updateNotificationUI();
        }

        toggleReadStatus(notificationId) {
            const notification = this.notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = !notification.read;
                this.saveNotifications();
                this.updateNotificationUI();
            }
        }

        deleteNotification(notificationId) {
            this.notifications = this.notifications.filter(n => n.id !== notificationId);
            this.saveNotifications();
            this.updateNotificationUI();
        }

        clearAllNotifications() {
            this.notifications = [];
            this.saveNotifications();
            this.updateNotificationUI();
        }

        toggleNotificationPanel() {
            const notificationSystem = document.getElementById('notificationSystem');
            if (notificationSystem) {
                notificationSystem.classList.toggle('show');
            }
        }

        hideNotificationPanel() {
            const notificationSystem = document.getElementById('notificationSystem');
            if (notificationSystem) {
                notificationSystem.classList.remove('show');
            }
        }

        toggleSettingsPanel() {
            const notificationSettings = document.getElementById('notificationSettings');
            if (notificationSettings) {
                notificationSettings.classList.toggle('show');
            }
        }

        hideSettingsPanel() {
            const notificationSettings = document.getElementById('notificationSettings');
            if (notificationSettings) {
                notificationSettings.classList.remove('show');
            }
        }

        showBrowserNotification(notification) {
            if (!this.settings.browserNotifications || !('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                const browserNotification = new Notification(notification.title, {
                    body: notification.message,
                    icon: '/favicon.ico',
                    tag: notification.id
                });

                browserNotification.onclick = () => {
                    this.handleNotificationClick(notification);
                    window.focus();
                };
            }
        }

        showUrgentDeadlineAlert(notification, opportunity) {
            const modal = document.getElementById('deadlineAlertModal');
            const message = document.getElementById('deadlineAlertMessage');
            
            if (modal && message) {
                message.textContent = notification.message;
                modal.classList.add('show');
                
                // Store current opportunity for action buttons
                this.currentAlertOpportunity = opportunity;
                this.currentAlertNotification = notification;
            }
        }

        hideDeadlineAlert() {
            const modal = document.getElementById('deadlineAlertModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        viewOpportunity() {
            if (this.currentAlertOpportunity) {
                showOpportunityDetails(this.currentAlertOpportunity);
                this.hideDeadlineAlert();
            }
        }

        snoozeDeadline() {
            if (this.currentAlertNotification) {
                // Remove current notification and create a new one for 24 hours later
                this.deleteNotification(this.currentAlertNotification.id);
                
                const snoozeTime = new Date();
                snoozeTime.setHours(snoozeTime.getHours() + 24);
                
                // You could implement more sophisticated snooze logic here
                this.hideDeadlineAlert();
                showNotification('Reminder snoozed for 24 hours');
            }
        }

        dismissDeadline() {
            if (this.currentAlertNotification) {
                this.markAsRead(this.currentAlertNotification.id);
                this.hideDeadlineAlert();
            }
        }

        hasBeenNotified(notificationId) {
            const notified = localStorage.getItem(`notified_${notificationId}`);
            return notified === 'true';
        }

        markAsNotified(notificationId) {
            localStorage.setItem(`notified_${notificationId}`, 'true');
            
            // Auto-expire the "notified" marker after deadline passes
            const expireTime = new Date();
            expireTime.setDate(expireTime.getDate() + 30); // 30 days from now
            localStorage.setItem(`notified_expire_${notificationId}`, expireTime.toISOString());
        }

        // Clean up expired notification markers
        cleanupExpiredMarkers() {
            const now = new Date();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('notified_expire_')) {
                    const expireTime = new Date(localStorage.getItem(key));
                    if (expireTime < now) {
                        const notificationId = key.replace('notified_expire_', '');
                        localStorage.removeItem(key);
                        localStorage.removeItem(`notified_${notificationId}`);
                    }
                }
            }
        }
    }

    // Multi-Select Functionality
    class MultiSelect {
        constructor(inputId, dropdownId, tagsId, options) {
            this.input = document.getElementById(inputId);
            this.dropdown = document.getElementById(dropdownId);
            this.tags = document.getElementById(tagsId);
            this.options = options;
            this.selected = [];
            this.init();
        }

        init() {
            // Populate dropdown with options
            this.populateDropdown();

            // Add event listeners
            this.input.addEventListener('click', () => {
                this.toggleDropdown();
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!this.input.contains(e.target) && !this.dropdown.contains(e.target)) {
                    this.hideDropdown();
                }
            });

            // Update input placeholder based on selection
            this.updateInputPlaceholder();
        }

        populateDropdown() {
            this.dropdown.innerHTML = '';
            
            for (const [key, value] of Object.entries(this.options)) {
                const option = document.createElement('div');
                option.className = 'multiselect-option';
                option.innerHTML = `
                    <input type="checkbox" id="${key}" value="${key}">
                    <label for="${key}">${value}</label>
                `;
                
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const checkbox = option.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        this.selectOption(key, value);
                    } else {
                        this.deselectOption(key);
                    }
                });
                
                this.dropdown.appendChild(option);
            }
        }

        selectOption(key, value) {
            if (!this.selected.includes(key)) {
                this.selected.push(key);
                this.renderTags();
                this.updateInputPlaceholder();
            }
        }

        deselectOption(key) {
            this.selected = this.selected.filter(item => item !== key);
            this.renderTags();
            this.updateInputPlaceholder();
        }

        renderTags() {
            this.tags.innerHTML = '';
            
            this.selected.forEach(key => {
                const tag = document.createElement('div');
                tag.className = 'multiselect-tag';
                tag.innerHTML = `
                    ${this.options[key]}
                    <i class="fas fa-times" data-value="${key}"></i>
                `;
                
                tag.querySelector('i').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deselectOption(key);
                });
                
                this.tags.appendChild(tag);
            });
        }

        updateInputPlaceholder() {
            if (this.selected.length === 0) {
                this.input.placeholder = 'Select options...';
            } else {
                this.input.placeholder = `${this.selected.length} selected`;
            }
        }

        toggleDropdown() {
            this.dropdown.classList.toggle('show');
        }

        hideDropdown() {
            this.dropdown.classList.remove('show');
        }

        getSelected() {
            return this.selected;
        }

        setSelected(values) {
            if (Array.isArray(values)) {
                this.selected = values;
            } else {
                this.selected = values ? [values] : [];
            }
            this.renderTags();
            this.updateInputPlaceholder();
            
            // Update checkboxes in dropdown
            const checkboxes = this.dropdown.querySelectorAll('input');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.selected.includes(checkbox.value);
            });
        }

        clear() {
            this.selected = [];
            this.renderTags();
            this.updateInputPlaceholder();
            
            // Uncheck all checkboxes
            const checkboxes = this.dropdown.querySelectorAll('input');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
    }

    // Initialize multi-select components
    let fieldMultiSelect, typeMultiSelect, adminFieldMultiSelect, adminTypeMultiSelect;

    // DUPLICATE DETECTION FUNCTIONS
    function fuzzyMatch(str1, str2, threshold = 0.8) {
        if (!str1 || !str2) return 0;
        
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        
        if (longer.length === 0) return 1.0;
        
        // Simple similarity calculation
        const longerLower = longer.toLowerCase();
        const shorterLower = shorter.toLowerCase();
        
        if (longerLower.includes(shorterLower)) return 1.0;
        
        // Simple character matching (for demo - consider using Levenshtein distance)
        let matches = 0;
        for (let i = 0; i < shorterLower.length; i++) {
            if (longerLower.includes(shorterLower[i])) matches++;
        }
        
        return matches / longerLower.length;
    }

    // Enhanced duplicate check with fuzzy matching
    async function checkForDuplicateOpportunity(opportunityData) {
        const opportunitiesRef = ref(database, 'opportunities');
        const snapshot = await get(opportunitiesRef);
        
        if (!snapshot.exists()) return { isDuplicate: false };
        
        const opportunities = snapshot.val();
        const duplicates = [];
        
        for (const key in opportunities) {
            const existingOpp = opportunities[key];
            let similarityScore = 0;
            let reason = "";
            
            // Title similarity (most important)
            const titleSimilarity = fuzzyMatch(existingOpp.title, opportunityData.title);
            
            // Organization similarity
            const orgSimilarity = fuzzyMatch(existingOpp.organization, opportunityData.organization);
            
            // Check for exact matches first
            if (existingOpp.applyLink === opportunityData.applyLink) {
                duplicates.push({
                    existingOpportunity: existingOpp,
                    reason: "Exact same application link",
                    confidence: 100
                });
                continue;
            }
            
            // High similarity in both title and organization
            if (titleSimilarity > 0.9 && orgSimilarity > 0.9) {
                duplicates.push({
                    existingOpportunity: existingOpp,
                    reason: "Very similar title and organization",
                    confidence: Math.round((titleSimilarity + orgSimilarity) / 2 * 100)
                });
            }
            // High title similarity with same organization
            else if (titleSimilarity > 0.85 && existingOpp.organization.toLowerCase() === opportunityData.organization.toLowerCase()) {
                duplicates.push({
                    existingOpportunity: existingOpp,
                    reason: "Similar title with same organization",
                    confidence: Math.round(titleSimilarity * 100)
                });
            }
        }
        
        if (duplicates.length > 0) {
            // Return the highest confidence duplicate
            const bestMatch = duplicates.reduce((prev, current) => 
                (prev.confidence > current.confidence) ? prev : current
            );
            
            return {
                isDuplicate: true,
                existingOpportunity: bestMatch.existingOpportunity,
                reason: bestMatch.reason,
                confidence: bestMatch.confidence,
                allDuplicates: duplicates
            };
        }
        
        return { isDuplicate: false };
    }

    // Show duplicate warning modal
    function showDuplicateWarning(duplicateCheck, newOpportunity) {
        // Create a custom modal for duplicate handling
        const duplicateModal = document.createElement('div');
        duplicateModal.className = 'duplicate-warning-modal';
        duplicateModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        duplicateModal.innerHTML = `
            <div class="duplicate-warning-content">
                <h3><i class="fas fa-exclamation-triangle"></i> Possible Duplicate Found</h3>
                <p><strong>Reason:</strong> ${duplicateCheck.reason}</p>
                <p><strong>Confidence:</strong> ${duplicateCheck.confidence}% match</p>
                
                <div class="existing-opportunity-info">
                    <h4>Existing Opportunity:</h4>
                    <p><strong>Title:</strong> ${duplicateCheck.existingOpportunity.title}</p>
                    <p><strong>Organization:</strong> ${duplicateCheck.existingOpportunity.organization}</p>
                    <p><strong>Deadline:</strong> ${formatDate(duplicateCheck.existingOpportunity.deadline)}</p>
                    <p><strong>Added by:</strong> ${duplicateCheck.existingOpportunity.addedByName || 'Unknown'}</p>
                </div>
                
                <div class="duplicate-warning-actions">
                    <button class="cancel-duplicate-btn" id="cancelDuplicate">
                        Cancel
                    </button>
                    <button class="view-existing-btn" id="viewExisting">
                        View Existing
                    </button>
                    <button class="force-add-btn" id="forceAdd">
                        Add Anyway
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(duplicateModal);
        
        // Store references for cleanup
        let modalRemoved = false;
        
        function removeModal() {
            if (!modalRemoved && document.body.contains(duplicateModal)) {
                document.body.removeChild(duplicateModal);
                modalRemoved = true;
            }
        }
        
        // Event listeners for modal buttons
        document.getElementById('cancelDuplicate').addEventListener('click', () => {
            removeModal();
        });
        
        document.getElementById('viewExisting').addEventListener('click', () => {
            removeModal();
            closeAdminModal();
            
            // Find the existing opportunity with a more flexible search
            const existingOpp = allOpportunities.find(opp => 
                opp.id === duplicateCheck.existingOpportunity.id || // Match by ID if available
                (opp.title.toLowerCase() === duplicateCheck.existingOpportunity.title.toLowerCase() &&
                 opp.organization.toLowerCase() === duplicateCheck.existingOpportunity.organization.toLowerCase())
            );
            
            if (existingOpp) {
                // Small delay to ensure modal is closed
                setTimeout(() => {
                    showOpportunityDetails(existingOpp);
                }, 100);
            } else {
                showNotification('Could not find the existing opportunity.', 'error');
            }
        });
        
        document.getElementById('forceAdd').addEventListener('click', () => {
            removeModal();
            saveOpportunityData(null, newOpportunity);
        });
        
        // Close modal when clicking outside
        duplicateModal.addEventListener('click', (e) => {
            if (e.target === duplicateModal) {
                removeModal();
            }
        });
    }

    // Save opportunity data to Firebase
    function saveOpportunityData(opportunityId, opportunityData) {
        if (opportunityId) {
            // Update existing
            update(ref(database, `opportunities/${opportunityId}`), opportunityData)
                .then(() => {
                    adminModal.style.display = 'none';
                    showNotification('Opportunity updated successfully!');
                })
                .catch((error) => {
                    showNotification('Error updating opportunity: ' + error.message, 'error');
                });
        } else {
            // Add new
            const newOpportunityRef = push(ref(database, 'opportunities'));
            set(newOpportunityRef, opportunityData)
                .then(() => {
                    adminModal.style.display = 'none';
                    showNotification('Opportunity added successfully!');
                })
                .catch((error) => {
                    showNotification('Error adding opportunity: ' + error.message, 'error');
                });
        }
    }

    // Check all duplicates in the system
    async function checkAllDuplicates() {
        showNotification('Scanning for duplicates...', 'warning');
        
        const opportunitiesRef = ref(database, 'opportunities');
        const snapshot = await get(opportunitiesRef);
        
        if (!snapshot.exists()) {
            showNotification('No opportunities found to check.', 'warning');
            return;
        }
        
        const opportunities = snapshot.val();
        const opportunityList = Object.values(opportunities);
        const duplicates = [];
        
        // Compare all opportunities with each other
        for (let i = 0; i < opportunityList.length; i++) {
            for (let j = i + 1; j < opportunityList.length; j++) {
                const opp1 = opportunityList[i];
                const opp2 = opportunityList[j];
                
                const titleSimilarity = fuzzyMatch(opp1.title, opp2.title);
                const orgSimilarity = fuzzyMatch(opp1.organization, opp2.organization);
                
                if ((titleSimilarity > 0.9 && orgSimilarity > 0.8) || opp1.applyLink === opp2.applyLink) {
                    duplicates.push({ 
                        opp1, 
                        opp2, 
                        similarity: Math.round(titleSimilarity * 100),
                        reason: opp1.applyLink === opp2.applyLink ? "Same application link" : "Similar title and organization"
                    });
                }
            }
        }
        
        if (duplicates.length > 0) {
            showNotification(`Found ${duplicates.length} potential duplicate pairs`, 'warning');
            
            // Create a report
            let report = `Duplicate Report (${new Date().toLocaleDateString()})\n\n`;
            report += `Found ${duplicates.length} potential duplicate pairs:\n\n`;
            
            duplicates.forEach((dup, index) => {
                report += `${index + 1}. ${dup.reason} (${dup.similarity}% similarity)\n`;
                report += `   - "${dup.opp1.title}" by ${dup.opp1.organization}\n`;
                report += `   - "${dup.opp2.title}" by ${dup.opp2.organization}\n\n`;
            });
            
            // Show the report in an alert (for demo purposes)
            alert(report);
        } else {
            showNotification('No duplicates found in the system!', 'success');
        }
    }

    // Wait for DOM to be fully loaded before accessing elements
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authModal = document.getElementById('authModal');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const doLogin = document.getElementById('doLogin');
        const doSignup = document.getElementById('doSignup');
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');
        const notification = document.getElementById('notification');
        const opportunitiesGrid = document.getElementById('opportunitiesGrid');
        const dashboard = document.getElementById('dashboard');
        const adminPanel = document.getElementById('adminPanel');
        const navDashboard = document.querySelector('.nav-dashboard');
        const navHome = document.querySelector('.nav-home');
        const navOpportunities = document.querySelector('.nav-opportunities');
        const navCurator = document.querySelector('.nav-curator');
        const navAdmin = document.querySelector('.nav-admin');
        const heroSection = document.getElementById('heroSection');
        const filtersSection = document.getElementById('filtersSection');
        const opportunitiesTitle = document.getElementById('opportunitiesTitle');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const pendingOpportunities = document.getElementById('pendingOpportunities');
        const completedOpportunities = document.getElementById('completedOpportunities');
        const dashboardTabs = document.querySelectorAll('.dashboard-tab');
        const addOpportunityBtn = document.getElementById('addOpportunityBtn');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminOpportunityForm = document.getElementById('adminOpportunityForm');
        const adminCancelBtn = document.getElementById('adminCancelBtn');
        const adminOpportunitiesList = document.getElementById('adminOpportunitiesList');
        const googleSignIn = document.getElementById('googleSignIn');
        const googleSignUp = document.getElementById('googleSignUp');
        const passwordResetLink = document.getElementById('passwordResetLink');
        const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
        const detailsModal = document.getElementById('detailsModal');
        const detailsClose = document.getElementById('detailsClose');
        const detailsSaveBtn = document.getElementById('detailsSaveBtn');
        const adminFormat = document.getElementById('adminFormat');
        const locationFieldGroup = document.getElementById('locationFieldGroup');
        const checkDuplicateBtn = document.getElementById('checkDuplicateBtn');
        const checkDuplicatesBtn = document.getElementById('checkDuplicatesBtn');
        const footerOpportunities = document.querySelector('.footer-opportunities');
        const footerDashboard = document.querySelector('.footer-dashboard');
        const footerResources = document.querySelectorAll('.footer-resources');
        const mainHeader = document.getElementById('mainHeader');

        // Initialize multi-select components
        fieldMultiSelect = new MultiSelect('fieldInput', 'fieldDropdown', 'fieldTags', FIELD_OPTIONS);
        typeMultiSelect = new MultiSelect('typeInput', 'typeDropdown', 'typeTags', TYPE_OPTIONS);
        adminFieldMultiSelect = new MultiSelect('adminFieldInput', 'adminFieldDropdown', 'adminFieldTags', FIELD_OPTIONS);
        adminTypeMultiSelect = new MultiSelect('adminTypeInput', 'adminTypeDropdown', 'adminTypeTags', TYPE_OPTIONS);

        // Event Listeners
        if (loginBtn) loginBtn.addEventListener('click', () => showAuthModal('login'));
        if (signupBtn) signupBtn.addEventListener('click', () => showAuthModal('signup'));
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        
        if (authTabs) {
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchAuthTab(tabName);
                });
            });
        }
        
        if (doLogin) doLogin.addEventListener('click', handleLogin);
        if (doSignup) doSignup.addEventListener('click', handleSignup);
        
        if (navDashboard) {
            navDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                showDashboard();
            });
        }
        
        if (navHome) {
            navHome.addEventListener('click', (e) => {
                e.preventDefault();
                showHome();
            });
        }
        
        if (navOpportunities) {
            navOpportunities.addEventListener('click', (e) => {
                e.preventDefault();
                showOpportunities();
            });
        }
        
        if (navCurator) {
            navCurator.addEventListener('click', (e) => {
                e.preventDefault();
                showCuratorProfile();
            });
        }
        
        if (navAdmin) {
            navAdmin.addEventListener('click', (e) => {
                e.preventDefault();
                showAdminPanel();
            });
        }

        if (searchBtn) searchBtn.addEventListener('click', applySearchFilter);
        if (searchInput) {
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') applySearchFilter();
            });
        }

        if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', applyFilters);
        if (resetFiltersBtn) resetFiltersBtn.addEventListener('click', resetFilters);

        if (dashboardTabs) {
            dashboardTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchDashboardTab(tabName);
                });
            });
        }

        if (addOpportunityBtn) addOpportunityBtn.addEventListener('click', () => showAdminModal());
        if (adminCancelBtn) adminCancelBtn.addEventListener('click', () => adminModal.style.display = 'none');
        if (adminOpportunityForm) adminOpportunityForm.addEventListener('submit', handleAdminFormSubmit);

        // Google Sign-In/Sign-Up buttons
        if (googleSignIn) googleSignIn.addEventListener('click', () => handleGoogleSignIn());
        if (googleSignUp) googleSignUp.addEventListener('click', () => handleGoogleSignIn());
        
        // Password reset link
        if (passwordResetLink) passwordResetLink.addEventListener('click', handlePasswordReset);
        
        // Details modal
        if (detailsClose) detailsClose.addEventListener('click', closeOpportunityDetails);
        if (detailsSaveBtn) detailsSaveBtn.addEventListener('click', handleDetailsSave);

        // Format change handler for admin form
        if (adminFormat) {
            adminFormat.addEventListener('change', handleFormatChange);
        }

        // Duplicate checking buttons
        if (checkDuplicateBtn) {
            checkDuplicateBtn.addEventListener('click', handleCheckDuplicate);
        }
        
        if (checkDuplicatesBtn) {
            checkDuplicatesBtn.addEventListener('click', checkAllDuplicates);
        }

        // Footer links functionality
        if (footerOpportunities) {
            footerOpportunities.addEventListener('click', (e) => {
                e.preventDefault();
                showOpportunities();
            });
        }
        
        if (footerDashboard) {
            footerDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                showDashboard();
            });
        }
        
        if (footerResources) {
            footerResources.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showNotification('Resources section coming soon!', 'info');
                });
            });
        }

        // Leaderboard tab switching
        const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
        leaderboardTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                leaderboardTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // You can implement time-based filtering here
                loadLeaderboard();
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.style.display = 'none';
            }
            if (e.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (e.target === detailsModal) {
                closeOpportunityDetails();
            }
        });

        // Header scroll behavior
        window.addEventListener('scroll', () => {
            const currentScrollPosition = window.pageYOffset;
            
            if (window.innerWidth <= 768) { // Only apply on mobile
                if (currentScrollPosition > lastScrollPosition && currentScrollPosition > 100) {
                    // Scrolling down - hide header
                    mainHeader.classList.add('hidden');
                } else {
                    // Scrolling up - show header
                    mainHeader.classList.remove('hidden');
                }
            }
            
            lastScrollPosition = currentScrollPosition;
        });

        // Check auth state
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // User is signed in
    if (loginBtn) loginBtn.style.display = 'none';
    if (signupBtn) signupBtn.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'block';
    if (notificationSettingsBtn) notificationSettingsBtn.style.display = 'block';
    
    // Show curator navigation
    document.querySelector('.nav-curator').style.display = 'list-item';
    
    // Check admin status with role information
    try {
      const adminStatus = await checkAdminStatus(user.uid);
      isAdminUser = adminStatus.isAdmin;
      
      if (navAdmin) {
        navAdmin.style.display = isAdminUser ? 'list-item' : 'none';
        
        // Add role badge to admin nav item if user is admin
        if (isAdminUser) {
          const roleBadge = adminStatus.role === ADMIN_ROLES.SUPER_ADMIN ? ' (Super Admin)' : ' (Admin)';
          navAdmin.innerHTML = `Admin${roleBadge}`;
        }
      }
    } catch (error) {
      console.error('Error checking admin status:', error);
      isAdminUser = false;
    }
    
    // Initialize curator system
    initCuratorSystem();
    
    // Rest of your existing code...
  } else {
                // User is signed out - Reset everything
                if (loginBtn) loginBtn.style.display = 'block';
                if (signupBtn) signupBtn.style.display = 'block';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (notificationSettingsBtn) notificationSettingsBtn.style.display = 'none';
                if (navAdmin) navAdmin.style.display = 'none';
                if (navCurator) navCurator.style.display = 'none';
                
                // Hide notification bell
                const notificationBell = document.getElementById('notificationBell');
                if (notificationBell) {
                    notificationBell.style.display = 'none';
                }
                
                // Clean up notification manager
                if (notificationManager) {
                    notificationManager.cleanup();
                    notificationManager = null;
                }
                
                // Clear user opportunities
                userOpportunities = {
                    pending: [],
                    completed: []
                };
                
                // Remove the user opportunities listener
                if (userOpportunitiesListener) {
                    userOpportunitiesListener();
                    userOpportunitiesListener = null;
                }
                
                // Hide dashboard and admin panel
                if (dashboard) dashboard.style.display = 'none';
                if (adminPanel) adminPanel.style.display = 'none';
                if (document.getElementById('curatorProfile')) document.getElementById('curatorProfile').style.display = 'none';
                if (document.getElementById('leaderboardSection')) document.getElementById('leaderboardSection').style.display = 'none';
                
                // Always show home page when logging out
                setTimeout(() => {
                    showHome();
                    renderOpportunities(); // Ensure opportunities are rendered
                }, 100);
                
                // Reset admin status
                isAdminUser = false;
            }
        });

// Default permissions based on role - ADD THIS FIRST
function getDefaultPermissions(role) {
  if (role === ADMIN_ROLES.SUPER_ADMIN) {
    return {
      canManageAllOpportunities: true,
      canManageUsers: true,
      canManageAdmins: true,
      canDeleteAny: true,
      canEditAny: true
    };
  } else {
    return {
      canManageAllOpportunities: false,
      canManageUsers: false,
      canManageAdmins: false,
      canDeleteAny: false,
      canEditAny: false
    };
  }
}

        // Check if user is admin using Firebase rules
async function checkAdminStatus(userId) {
  try {
    const adminRef = ref(database, `admins/${userId}`);
    const snapshot = await get(adminRef);
    
    if (snapshot.exists()) {
      const adminData = snapshot.val();
      return {
        isAdmin: true,
        role: adminData.role || ADMIN_ROLES.ADMIN,
        permissions: adminData.permissions || getDefaultPermissions(adminData.role)
      };
    }
    return { isAdmin: false, role: null, permissions: null };
  } catch (error) {
    console.error('Error checking admin status:', error);
    return { isAdmin: false, role: null, permissions: null };
  }
}

async function canUserModifyOpportunity(opportunityId) {
  const user = auth.currentUser;
  if (!user) return false;
  
  const adminStatus = await checkAdminStatus(user.uid);
  
  // Super admins can modify anything
  if (adminStatus.role === ADMIN_ROLES.SUPER_ADMIN) {
    return true;
  }
  
  // Regular admins can only modify their own opportunities
  if (adminStatus.isAdmin) {
    try {
      const opportunityRef = ref(database, `opportunities/${opportunityId}`);
      const snapshot = await get(opportunityRef);
      
      if (snapshot.exists()) {
        const opportunity = snapshot.val();
        return opportunity.addedBy === user.uid;
      }
    } catch (error) {
      console.error('Error checking opportunity ownership:', error);
    }
  }
  
  return false;
}

        function renderAdminManagement() {
  const adminPanel = document.getElementById('adminPanel');
  
  // Check if admin management section already exists
  const existingSection = document.querySelector('.admin-management');
  if (existingSection) {
    existingSection.remove();
  }
  
  // Create admin management section
  const adminManagementSection = document.createElement('div');
  adminManagementSection.className = 'admin-management';
  adminManagementSection.innerHTML = `
    <div class="admin-header">
      <h2>Admin Management</h2>
      <button class="apply-btn" id="addAdminBtn">Add New Admin</button>
    </div>
    <table class="admin-table" id="adminManagementTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Added By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminManagementList">
        <!-- Admin list will be populated here -->
      </tbody>
    </table>
  `;
  
  adminPanel.appendChild(adminManagementSection);
  
  // Load and render admin list
  loadAdminList();
}

async function loadAdminList() {
  try {
    const adminsRef = ref(database, 'admins');
    const snapshot = await get(adminsRef);
    
    if (!snapshot.exists()) return;
    
    const adminList = document.getElementById('adminManagementList');
    if (!adminList) return;
    
    adminList.innerHTML = '';
    
    const admins = snapshot.val();
    
    for (const [userId, adminData] of Object.entries(admins)) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${adminData.name || 'Unknown'}</td>
        <td>${adminData.email || 'Unknown'}</td>
        <td>
          <select class="role-select" data-userid="${userId}">
            <option value="admin" ${adminData.role === 'admin' ? 'selected' : ''}>Admin</option>
            <option value="super-admin" ${adminData.role === 'super-admin' ? 'selected' : ''}>Super Admin</option>
          </select>
        </td>
        <td>${adminData.addedBy || 'system'}</td>
        <td>
          <button class="admin-btn delete-btn remove-admin-btn" data-userid="${userId}">Remove</button>
        </td>
      `;
      
      adminList.appendChild(row);
      
      // Add event listeners
      const roleSelect = row.querySelector('.role-select');
      roleSelect.addEventListener('change', function() {
        updateAdminRole(this.getAttribute('data-userid'), this.value);
      });
      
      const removeBtn = row.querySelector('.remove-admin-btn');
      removeBtn.addEventListener('click', function() {
        removeAdmin(this.getAttribute('data-userid'));
      });
    }
  } catch (error) {
    console.error('Error loading admin list:', error);
  }
}

async function updateAdminRole(userId, newRole) {
  try {
    const user = auth.currentUser;
    const currentAdminStatus = await checkAdminStatus(user.uid);
    
    // Only super admins can update roles
    if (currentAdminStatus.role !== ADMIN_ROLES.SUPER_ADMIN) {
      showNotification('Only super admins can update admin roles', 'error');
      return;
    }
    
    await update(ref(database, `admins/${userId}`), {
      role: newRole
    });
    
    showNotification(`Admin role updated to ${newRole}`);
  } catch (error) {
    console.error('Error updating admin role:', error);
    showNotification('Error updating admin role', 'error');
  }
}

async function removeAdmin(userId) {
  try {
    const user = auth.currentUser;
    const currentAdminStatus = await checkAdminStatus(user.uid);
    
    // Only super admins can remove admins
    if (currentAdminStatus.role !== ADMIN_ROLES.SUPER_ADMIN) {
      showNotification('Only super admins can remove admins', 'error');
      return;
    }
    
    // Prevent removing yourself
    if (userId === user.uid) {
      showNotification('You cannot remove yourself as admin', 'error');
      return;
    }
    
    if (confirm('Are you sure you want to remove this admin?')) {
      await remove(ref(database, `admins/${userId}`));
      showNotification('Admin removed successfully');
      loadAdminList(); // Refresh the list
    }
  } catch (error) {
    console.error('Error removing admin:', error);
    showNotification('Error removing admin', 'error');
  }
}

        // Load opportunities from Firebase
      function loadOpportunitiesFromFirebase() {
    const opportunitiesRef = ref(database, 'opportunities');
    
    onValue(opportunitiesRef, (snapshot) => {
        const data = snapshot.val();
        allOpportunities = [];
        
        if (data) {
            for (const key in data) {
                allOpportunities.push({
                    id: key,
                    ...data[key]
                });
            }
            
            // Fix for existing opportunities without fields - set them to 'any'
            allOpportunities.forEach(opp => {
                if (!opp.field || (Array.isArray(opp.field) && opp.field.length === 0)) {
                    opp.field = ['any'];
                }
            });
        }
        
        // Apply current filters and render opportunities
        applyFilters();
        
        // Render admin opportunities if admin panel is visible
        if (adminPanel && adminPanel.style.display === 'block') {
            renderAdminOpportunities();
        }
        
        // Update curator system with new opportunities data
        if (auth.currentUser) {
            loadCuratorStats();
            loadLeaderboard();
        }
    });
}

// Render opportunities to the grid
function renderOpportunities() {
    if (!opportunitiesGrid) return;
    
    opportunitiesGrid.innerHTML = '';
    
    if (filteredOpportunities.length === 0) {
        opportunitiesGrid.innerHTML = '<p class="no-results">No opportunities match your filters. Try adjusting your search criteria.</p>';
        return;
    }
    
    filteredOpportunities.forEach(opp => {
        const isSaved = userOpportunities.pending.some(item => item.id === opp.id) || 
                       userOpportunities.completed.some(item => item.id === opp.id);
        
        const isExpired = isOpportunityExpired(opp.deadline);
        const isUrgent = isDeadlineUrgent(opp.deadline);
        const timeRemaining = calculateTimeRemaining(opp.deadline);
        
        // Get the first type for styling
        const firstType = Array.isArray(opp.type) ? opp.type[0] : opp.type;
        const firstField = Array.isArray(opp.field) ? opp.field[0] : opp.field;
        
        const opportunityCard = document.createElement('div');
        opportunityCard.className = `opportunity-card ${isExpired ? 'expired' : ''}`;
        opportunityCard.innerHTML = `
            <div class="card-header">
                <span class="opportunity-badge type-badge">${getOpportunityTypeText(opp.type)}</span>
                <span class="opportunity-badge field-badge">${getFieldText(opp.field)}</span>
                ${getFormatBadge(opp.format)}
                <h3>${opp.title || 'Untitled Opportunity'}</h3>
                <p class="organization">${opp.organization || 'Unknown Organization'}</p>
            </div>
            
            <div class="card-body">
                <div class="detail">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="deadline ${isUrgent ? 'urgent' : ''}">Deadline: ${formatDate(opp.deadline)} 
                        <span class="time-remaining ${timeRemaining.class}">${timeRemaining.text}</span>
                    </span>
                </div>
                <p>${(opp.description || 'No description available').substring(0, 150)}${opp.description && opp.description.length > 150 ? '...' : ''}</p>
            </div>
            
            <div class="card-footer">
                <div class="card-actions">
                    <div class="left-actions">
                        <button class="save-btn ${isSaved ? 'saved' : ''}" data-id="${opp.id}" title="${isSaved ? 'Remove from dashboard' : 'Save to dashboard'}">
                            <i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i>
                        </button>
                    </div>
                    <div class="right-actions">
                        <button class="details-btn" data-id="${opp.id}">View Details</button>
                        <a href="${opp.applyLink || '#'}" target="_blank" class="apply-link">Apply Now</a>
                    </div>
                </div>
            </div>
        `;
        
        opportunitiesGrid.appendChild(opportunityCard);
        
        // Add event listeners to save buttons
        const saveButton = opportunityCard.querySelector('.save-btn');
        saveButton.addEventListener('click', function() {
            const user = auth.currentUser;
            if (user) {
                const oppId = this.getAttribute('data-id');
                const opportunity = allOpportunities.find(opp => opp.id === oppId);
                if (this.classList.contains('saved')) {
                    removeOpportunity(user.uid, opportunity);
                } else {
                    saveOpportunity(user.uid, opportunity);
                }
            } else {
                showAuthModal('login');
                showNotification('Please sign in to save opportunities', 'warning');
            }
        });
        
        // Add event listener to details button
        const detailsButton = opportunityCard.querySelector('.details-btn');
        detailsButton.addEventListener('click', function() {
            const oppId = this.getAttribute('data-id');
            const opportunity = allOpportunities.find(opp => opp.id === oppId);
            showOpportunityDetails(opportunity);
        });
    });
}

// Handle details modal save button
function handleDetailsSave() {
    const user = auth.currentUser;
    if (user && currentOpportunityDetails) {
        if (detailsSaveBtn.classList.contains('saved')) {
            removeOpportunity(user.uid, currentOpportunityDetails);
        } else {
            saveOpportunity(user.uid, currentOpportunityDetails);
        }
    } else {
        showAuthModal('login');
        showNotification('Please sign in to save opportunities', 'warning');
    }
}

// Render admin opportunities
function renderAdminOpportunities() {
    if (!adminOpportunitiesList) return;
    
    adminOpportunitiesList.innerHTML = '';
    
    if (allOpportunities.length === 0) {
        adminOpportunitiesList.innerHTML = '<tr><td colspan="8" style="text-align: center;">No opportunities found</td></tr>';
        return;
    }
    
    allOpportunities.forEach(async (opp) => {
        const timeRemaining = calculateTimeRemaining(opp.deadline);
        const canModify = await canUserModifyOpportunity(opp.id);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${opp.title || 'Untitled'}</td>
            <td>${opp.organization || 'Unknown'}</td>
            <td>${getOpportunityTypeText(opp.type)}</td>
            <td>${getFormatText(opp.format)}</td>
            <td>${formatDate(opp.deadline)} <span class="time-remaining ${timeRemaining.class}">${timeRemaining.text}</span></td>
            <td>${opp.addedByName || 'Unknown'}</td>
            <td>${opp.addedBy === auth.currentUser?.uid ? 'You' : 'Other Admin'}</td>
            <td class="admin-actions-cell">
                <button class="admin-btn edit-btn" data-id="${opp.id}" ${!canModify ? 'disabled' : ''}>Edit</button>
                <button class="admin-btn delete-btn" data-id="${opp.id}" ${!canModify ? 'disabled' : ''}>Delete</button>
            </td>
        `;
        
        adminOpportunitiesList.appendChild(row);
        
        // Add event listeners to edit and delete buttons
        const editButton = row.querySelector('.edit-btn');
        editButton.addEventListener('click', function() {
            if (this.disabled) {
                showNotification('You can only edit opportunities that you created', 'warning');
                return;
            }
            const oppId = this.getAttribute('data-id');
            const opportunity = allOpportunities.find(opp => opp.id === oppId);
            showAdminModal(opportunity);
        });
        
        const deleteButton = row.querySelector('.delete-btn');
        deleteButton.addEventListener('click', function() {
            if (this.disabled) {
                showNotification('You can only delete opportunities that you created', 'warning');
                return;
            }
            const oppId = this.getAttribute('data-id');
            deleteOpportunity(oppId);
        });
    });
}

// Show auth modal
function showAuthModal(tab) {
    if (!authModal) return;
    authModal.style.display = 'flex';
    switchAuthTab(tab);
}

// Switch auth tab
function switchAuthTab(tabName) {
    if (!authTabs || !loginForm || !signupForm) return;
    
    // Update tabs
    authTabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Update forms
    if (tabName === 'login') {
        loginForm.classList.add('active');
        signupForm.classList.remove('active');
    } else {
        loginForm.classList.remove('active');
        signupForm.classList.add('active');
    }
    
    // Clear errors
    if (loginError) loginError.style.display = 'none';
    if (signupError) signupError.style.display = 'none';
}

// Handle format change in admin form
function handleFormatChange() {
    const format = adminFormat.value;
    const locationInput = document.getElementById('adminLocation');
    
    if (format === 'online') {
        locationFieldGroup.style.display = 'none';
        locationInput.required = false;
        locationInput.value = 'Online';
    } else {
        locationFieldGroup.style.display = 'block';
        locationInput.required = true;
        if (locationInput.value === 'Online') {
            locationInput.value = '';
        }
    }
}

// Handle login
function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        if (loginError) {
            loginError.textContent = 'Please enter both email and password';
            loginError.style.display = 'block';
        }
        return;
    }
    
    signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            // Signed in 
            if (authModal) authModal.style.display = 'none';
            showNotification('Successfully logged in!');
        })
        .catch((error) => {
            if (loginError) {
                let errorMessage = error.message;
                // Make error messages more user-friendly
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid credentials';
                }
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            }
        });
}

// Handle signup
function handleSignup() {
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;
    
    // Basic validation
    if (!name || !email || !password || !confirm) {
        if (signupError) {
            signupError.textContent = 'Please fill in all fields';
            signupError.style.display = 'block';
        }
        return;
    }
    
    if (password !== confirm) {
        if (signupError) {
            signupError.textContent = 'Passwords do not match';
            signupError.style.display = 'block';
        }
        return;
    }
    
    if (password.length < 6) {
        if (signupError) {
            signupError.textContent = 'Password should be at least 6 characters';
            signupError.style.display = 'block';
        }
        return;
    }
    
    createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            
            // Save user profile
            set(ref(database, 'users/' + user.uid), {
                name: name,
                email: email,
                createdAt: new Date().toISOString()
            });

            if (authModal) authModal.style.display = 'none';
            showNotification('Account created successfully!');
        })
        .catch((error) => {
            if (signupError) {
                let errorMessage = error.message;
                // Make error messages more user-friendly
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email already exists';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak';
                }
                signupError.textContent = errorMessage;
                signupError.style.display = 'block';
            }
        });
}

// Handle Google Sign-In
function handleGoogleSignIn() {
    signInWithPopup(auth, googleProvider)
        .then((result) => {
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            const user = result.user;
            
            const userRef = ref(database, 'users/' + user.uid);
            
            get(userRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    // User doesn't exist, create a new user record
                    set(userRef, {
                        name: user.displayName,
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        isGoogleUser: true
                    });
                    
                    // Note: Admin roles are managed exclusively in Firebase database
                    // No automatic admin assignment - all admin management done via Firebase
                }
                
                if (authModal) authModal.style.display = 'none';
                showNotification('Successfully signed in with Google!');
            });
        })
        .catch((error) => {
            // Handle Errors here
            const errorCode = error.code;
            const errorMessage = error.message;
            const email = error.customData?.email;
            const credential = GoogleAuthProvider.credentialFromError(error);
            
            // Show error in appropriate form
            const currentTab = document.querySelector('.auth-tab.active').getAttribute('data-tab');
            if (currentTab === 'login' && loginError) {
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            } else if (currentTab === 'signup' && signupError) {
                signupError.textContent = errorMessage;
                signupError.style.display = 'block';
            }
        });
}

// Check if email exists
async function checkEmailExists(email) {
    try {
        const signInMethods = await fetchSignInMethodsForEmail(auth, email);
        return signInMethods.length > 0;
    } catch (error) {
        console.error('Error checking email:', error);
        return false;
    }
}

// Handle password reset
async function handlePasswordReset() {
    const email = document.getElementById('loginEmail').value;
    
    if (!email) {
        showNotification('Please enter your email address first', 'warning');
        return;
    }
    
    // Basic email format validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        if (loginError) {
            loginError.textContent = 'Please enter a valid email address';
            loginError.style.display = 'block';
        }
        return;
    }
    
    try {
        // Check if email exists in Firebase Auth
        const emailExists = await checkEmailExists(email);
        
        if (!emailExists) {
            if (loginError) {
                loginError.textContent = 'This email is not registered with us';
                loginError.style.display = 'block';
            }
            return;
        }
        
        // If email exists, send password reset email
        await sendPasswordResetEmail(auth, email);
        showNotification('Password reset email sent. Check your inbox or spam folder.', 'success');
        
        // Clear any previous errors
        if (loginError) {
            loginError.style.display = 'none';
        }
    } catch (error) {
        console.error('Password reset error:', error);
        if (loginError) {
            loginError.textContent = error.message;
            loginError.style.display = 'block';
        }
    }
}

// Handle logout
function handleLogout() {
    // Clean up notification manager before logout
    if (notificationManager) {
        notificationManager.cleanup();
        notificationManager = null;
    }
    
    // Remove the user opportunities listener
    if (userOpportunitiesListener) {
        userOpportunitiesListener();
        userOpportunitiesListener = null;
    }
    
    // Clear user data
    userOpportunities = {
        pending: [],
        completed: []
    };
    
    // Sign out from Firebase
    signOut(auth)
        .then(() => {
            showNotification('Successfully logged out');
        })
        .catch((error) => {
            console.error('Logout error:', error);
        });
}

// Save opportunity to user's dashboard
function saveOpportunity(userId, opportunity) {
    const userOppRef = ref(database, `userOpportunities/${userId}/${opportunity.id}`);
    
    // Check if already saved in local state
    const alreadySaved = userOpportunities.pending.some(opp => opp.id === opportunity.id) || 
                        userOpportunities.completed.some(opp => opp.id === opportunity.id);
    
    if (alreadySaved) {
        showNotification('This opportunity is already in your dashboard!', 'warning');
        return;
    }
    
    // Store only a reference to the opportunity, not the full object
    set(userOppRef, {
        opportunityId: opportunity.id,
        savedAt: new Date().toISOString(),
        status: 'pending'
    })
    .then(() => {
        showNotification('Opportunity saved to your dashboard!');
        
        // Update the details modal save button if it's open for this opportunity
        if (currentOpportunityDetails && currentOpportunityDetails.id === opportunity.id) {
            const detailsSaveBtn = document.getElementById('detailsSaveBtn');
            if (detailsSaveBtn) {
                detailsSaveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Remove from Dashboard';
                detailsSaveBtn.classList.add('saved');
            }
        }
    })
    .catch((error) => {
        console.error('Error saving opportunity:', error);
    });
}

// Remove opportunity from user's dashboard
function removeOpportunity(userId, opportunity) {
    const userOppRef = ref(database, `userOpportunities/${userId}/${opportunity.id}`);
    
    remove(userOppRef)
    .then(() => {
        showNotification('Opportunity removed from your dashboard');
        
        // Update the details modal save button if it's open for this opportunity
        if (currentOpportunityDetails && currentOpportunityDetails.id === opportunity.id) {
            const detailsSaveBtn = document.getElementById('detailsSaveBtn');
            if (detailsSaveBtn) {
                detailsSaveBtn.innerHTML = '<i class="far fa-bookmark"></i> Save to Dashboard';
                detailsSaveBtn.classList.remove('saved');
            }
        }
    })
    .catch((error) => {
        console.error('Error removing opportunity:', error);
    });
}

// Load user's saved opportunities
function loadUserOpportunities(userId) {
    // Remove previous listener if it exists
    if (userOpportunitiesListener) {
        userOpportunitiesListener();
    }
    
    const userOppRef = ref(database, `userOpportunities/${userId}`);
    
    // Set up the listener and store it for potential cleanup
    userOpportunitiesListener = onValue(userOppRef, (snapshot) => {
        const data = snapshot.val();
        
        // Always reset the arrays completely
        userOpportunities.pending = [];
        userOpportunities.completed = [];
        
        if (data) {
            // Create a map of all opportunities for quick lookup
            const opportunityMap = {};
            allOpportunities.forEach(opp => {
                opportunityMap[opp.id] = opp;
            });
            
            for (const key in data) {
                const savedOpp = data[key];
                const opportunityId = savedOpp.opportunityId || key;
                const fullOpportunity = opportunityMap[opportunityId];
                
                if (fullOpportunity) {
                    const opportunityWithStatus = {
                        ...fullOpportunity,
                        savedAt: savedOpp.savedAt,
                        status: savedOpp.status || 'pending'
                    };
                    
                    if (savedOpp.status === 'completed') {
                        userOpportunities.completed.push(opportunityWithStatus);
                    } else {
                        userOpportunities.pending.push(opportunityWithStatus);
                    }
                }
            }
        }
        
        renderOpportunities();
        renderDashboardOpportunities();
    });
}

// Render dashboard opportunities
function renderDashboardOpportunities() {
    // Render pending opportunities
    if (pendingOpportunities) {
        if (userOpportunities.pending.length === 0) {
            pendingOpportunities.innerHTML = `
                <div class="empty-state">
                    <i class="far fa-bookmark"></i>
                    <h3>No pending opportunities</h3>
                    <p>Save opportunities to your dashboard to track them here</p>
                </div>
            `;
        } else {
            pendingOpportunities.innerHTML = '';
            userOpportunities.pending.forEach(opp => {
                const oppElement = createDashboardOpportunityElement(opp, 'pending');
                pendingOpportunities.appendChild(oppElement);
            });
        }
    }
    
    // Render completed opportunities
    if (completedOpportunities) {
        if (userOpportunities.completed.length === 0) {
            completedOpportunities.innerHTML = `
                <div class="empty-state">
                    <i class="far fa-check-circle"></i>
                    <h3>No completed opportunities</h3>
                    <p>Mark opportunities as complete to track your achievements</p>
                </div>
            `;
        } else {
            completedOpportunities.innerHTML = '';
            userOpportunities.completed.forEach(opp => {
                const oppElement = createDashboardOpportunityElement(opp, 'completed');
                completedOpportunities.appendChild(oppElement);
            });
        }
    }
}

// Create dashboard opportunity element
function createDashboardOpportunityElement(opportunity, status) {
    const isExpired = isOpportunityExpired(opportunity.deadline);
    const isUrgent = isDeadlineUrgent(opportunity.deadline);
    const timeRemaining = calculateTimeRemaining(opportunity.deadline);
    
    const element = document.createElement('div');
    element.className = `opportunity-card ${isExpired ? 'expired' : ''}`;
    element.innerHTML = `
        <div class="card-header">
            <span class="opportunity-badge type-badge">${getOpportunityTypeText(opportunity.type)}</span>
            <span class="opportunity-badge field-badge">${getFieldText(opportunity.field)}</span>
            ${getFormatBadge(opportunity.format)}
            <h3>${opportunity.title || 'Untitled Opportunity'}</h3>
            <p class="organization">${opportunity.organization || 'Unknown Organization'}</p>
        </div>
        
        <div class="card-body">
            <div class="detail">
                <i class="fas fa-calendar-alt"></i>
                <span class="deadline ${isUrgent ? 'urgent' : ''}">Deadline: ${formatDate(opportunity.deadline)} 
                    <span class="time-remaining ${timeRemaining.class}">${timeRemaining.text}</span>
                </span>
            </div>
            <p>${opportunity.description || 'No description available'}</p>
        </div>
        
        <div class="card-footer">
            <div class="card-actions">
                <div class="left-actions">
                    <button class="save-btn saved" data-id="${opportunity.id}" title="Remove from dashboard">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>
                <div class="right-actions">
                    <button class="details-btn" data-id="${opportunity.id}">View Details</button>
                    <a href="${opportunity.applyLink || '#'}" target="_blank" class="apply-link">Apply Now</a>
                    ${status === 'pending' ? 
                    `<button class="apply-link complete-btn" data-id="${opportunity.id}">Mark as Complete</button>` : 
                    `<span class="completed-badge">Completed</span>`}
                </div>
            </div>
        </div>
    `;
    
    // Add event listener to remove button
    const removeBtn = element.querySelector('.save-btn');
    removeBtn.addEventListener('click', function() {
        const user = auth.currentUser;
        if (user) {
            removeOpportunity(user.uid, opportunity);
        }
    });
    
    // Add event listener to details button
    const detailsBtn = element.querySelector('.details-btn');
    detailsBtn.addEventListener('click', function() {
        showOpportunityDetails(opportunity);
    });
    
    // Add event listener to complete button
    if (status === 'pending') {
        const completeBtn = element.querySelector('.complete-btn');
        completeBtn.addEventListener('click', function() {
            const user = auth.currentUser;
            if (user) {
                markAsComplete(user.uid, opportunity);
            }
        });
    }
    
    return element;
}

// Mark opportunity as complete
function markAsComplete(userId, opportunity) {
    const userOppRef = ref(database, `userOpportunities/${userId}/${opportunity.id}`);
    update(userOppRef, {
        status: 'completed',
        completedAt: new Date().toISOString()
    })
    .then(() => showNotification('Opportunity marked as complete!'))
    .catch((error) => console.error('Error updating opportunity:', error));
}

// Apply filters - FIXED: Handles "any" field properly
function applyFilters() {
    const selectedFields = fieldMultiSelect.getSelected();
    const selectedTypes = typeMultiSelect.getSelected();
    const formatFilter = document.getElementById('format').value;
    const deadlineFilter = document.getElementById('deadline').value;
    const languageFilter = document.getElementById('language').value;
    const searchTerm = searchInput.value.toLowerCase();
    
    filteredOpportunities = allOpportunities.filter(opp => {
        // Field filter - FIXED: Check if any selected field matches any of the opportunity's fields
        if (selectedFields.length > 0) {
            const oppFields = Array.isArray(opp.field) ? opp.field : [opp.field];
            
            // If opportunity has "any" field, it should match all field filters
            const hasAnyField = oppFields.includes('any');
            
            // If it doesn't have "any" field, check for matching fields
            const hasMatchingField = oppFields.some(field => selectedFields.includes(field));
            
            // Show opportunity if it has "any" field OR has a matching field
            if (!hasAnyField && !hasMatchingField) return false;
        }
        
        // Type filter - check if any selected type matches any of the opportunity's types
        if (selectedTypes.length > 0) {
            const oppTypes = Array.isArray(opp.type) ? opp.type : [opp.type];
            const hasMatchingType = oppTypes.some(type => selectedTypes.includes(type));
            if (!hasMatchingType) return false;
        }
        
        // Format filter
        if (formatFilter && opp.format !== formatFilter) return false;
        
        // Language filter
        if (languageFilter && opp.language && opp.language !== languageFilter) return false;
        
        // Search term filter
        if (searchTerm && !(
            (opp.title && opp.title.toLowerCase().includes(searchTerm)) ||
            (opp.organization && opp.organization.toLowerCase().includes(searchTerm)) ||
            (opp.description && opp.description.toLowerCase().includes(searchTerm)) ||
            (opp.field && (Array.isArray(opp.field) ? 
                opp.field.some(f => {
                    // Include "Any Field" in search results for any search term
                    if (f === 'any') return true;
                    return FIELD_OPTIONS[f] && FIELD_OPTIONS[f].toLowerCase().includes(searchTerm);
                }) : 
                // For single field, include if it's "any" or matches the search
                (opp.field === 'any' || (FIELD_OPTIONS[opp.field] && FIELD_OPTIONS[opp.field].toLowerCase().includes(searchTerm)))
            ))
        )) return false;
        
        // Deadline filter - check if deadline is within specified timeframe
        if (deadlineFilter && opp.deadline) {
            const today = new Date();
            const oppDeadline = new Date(opp.deadline);
            
            // Skip expired opportunities for deadline filter
            if (oppDeadline < today) return false;
            
            const diffTime = oppDeadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (deadlineFilter === 'week' && diffDays > 7) return false;
            if (deadlineFilter === 'month' && diffDays > 30) return false;
            if (deadlineFilter === '3months' && diffDays > 90) return false;
        }
        
        return true;
    });
    
    renderOpportunities();
    showNotification(`Found ${filteredOpportunities.length} opportunities matching your filters`);
}

// Apply search filter
function applySearchFilter() {
    applyFilters();
}

// Reset filters
function resetFilters() {
    fieldMultiSelect.clear();
    typeMultiSelect.clear();
    document.getElementById('format').value = '';
    document.getElementById('deadline').value = '';
    document.getElementById('language').value = '';
    if (searchInput) searchInput.value = '';
    
    filteredOpportunities = [...allOpportunities];
    renderOpportunities();
    showNotification('Filters reset');
}

// Show dashboard
function showDashboard() {
    const user = auth.currentUser;
    if (user) {
        // Hide other sections and show dashboard
        if (heroSection) heroSection.style.display = 'none';
        if (filtersSection) filtersSection.style.display = 'none';
        if (opportunitiesTitle) opportunitiesTitle.style.display = 'none';
        if (opportunitiesGrid) opportunitiesGrid.style.display = 'none';
        if (adminPanel) adminPanel.style.display = 'none';
        if (dashboard) dashboard.style.display = 'block';
        if (document.getElementById('curatorProfile')) document.getElementById('curatorProfile').style.display = 'none';
        if (document.getElementById('leaderboardSection')) document.getElementById('leaderboardSection').style.display = 'none';
    } else {
        showAuthModal('login');
        showNotification('Please sign in to view your dashboard', 'warning');
    }
}

// Show home page
function showHome() {
    // Show all sections and hide dashboard and admin panel
    if (heroSection) heroSection.style.display = 'block';
    if (filtersSection) filtersSection.style.display = 'block';
    if (opportunitiesTitle) opportunitiesTitle.style.display = 'block';
    if (opportunitiesGrid) opportunitiesGrid.style.display = 'grid';
    if (dashboard) dashboard.style.display = 'none';
    if (adminPanel) adminPanel.style.display = 'none';
    if (document.getElementById('curatorProfile')) document.getElementById('curatorProfile').style.display = 'none';
    if (document.getElementById('leaderboardSection')) document.getElementById('leaderboardSection').style.display = 'none';
}

// Show opportunities page
function showOpportunities() {
    showHome();
}

// Show admin panel
function showAdminPanel() {
    const user = auth.currentUser;
    if (user) {
        checkAdminStatus(user.uid).then(adminStatus => {
            if (adminStatus.isAdmin) {
                // Hide other sections and show admin panel
                if (heroSection) heroSection.style.display = 'none';
                if (filtersSection) filtersSection.style.display = 'none';
                if (opportunitiesTitle) opportunitiesTitle.style.display = 'none';
                if (opportunitiesGrid) opportunitiesGrid.style.display = 'none';
                if (dashboard) dashboard.style.display = 'none';
                if (adminPanel) adminPanel.style.display = 'block';
                if (document.getElementById('curatorProfile')) document.getElementById('curatorProfile').style.display = 'none';
                if (document.getElementById('leaderboardSection')) document.getElementById('leaderboardSection').style.display = 'none';
                
                // Render admin opportunities
                renderAdminOpportunities();
                
                // Only show admin management for super admins
                if (adminStatus.role === ADMIN_ROLES.SUPER_ADMIN) {
                    renderAdminManagement();
                }
            } else {
                showNotification('Access denied. Admin privileges required.', 'error');
            }
        });
    } else {
        showNotification('Please sign in to access admin panel', 'warning');
    }
}

// Switch dashboard tab
function switchDashboardTab(tabName) {
    if (!dashboardTabs) return;
    
    // Update tabs
    dashboardTabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Update content
    if (tabName === 'pending') {
        document.getElementById('pendingContent').classList.add('active');
        document.getElementById('completedContent').classList.remove('active');
    } else {
        document.getElementById('pendingContent').classList.remove('active');
        document.getElementById('completedContent').classList.add('active');
    }
}

// Show admin modal for adding/editing opportunities - FIXED: Default to "any" field
function showAdminModal(opportunity = null) {
    if (!adminModal) return;
    
    // Check if user is admin
    const user = auth.currentUser;
    if (!user) {
        showNotification('Please sign in to access admin features', 'warning');
        return;
    }
    
    if (!isAdminUser) {
        showNotification('Access denied. Admin privileges required.', 'error');
        return;
    }
    
    if (opportunity) {
        // Editing existing opportunity
        adminModalTitle.textContent = 'Edit Opportunity';
        document.getElementById('opportunityId').value = opportunity.id;
        document.getElementById('adminTitle').value = opportunity.title;
        document.getElementById('adminOrganization').value = opportunity.organization;
        adminTypeMultiSelect.setSelected(opportunity.type);
        adminFieldMultiSelect.setSelected(opportunity.field);
        document.getElementById('adminFormat').value = opportunity.format;
        document.getElementById('adminDescription').value = opportunity.description;
        document.getElementById('adminLocation').value = opportunity.location;
        document.getElementById('adminDeadline').value = opportunity.deadline;
        document.getElementById('adminApplyLink').value = opportunity.applyLink;
        document.getElementById('adminTimeCommitment').value = opportunity.timeCommitment || '';
        document.getElementById('adminDuration').value = opportunity.duration || '';
        document.getElementById('adminLanguage').value = opportunity.language || '';
        
        // Handle format-specific UI
        handleFormatChange();
    } else {
        // Adding new opportunity - FIXED: Default to "any" field
        adminModalTitle.textContent = 'Add New Opportunity';
        adminOpportunityForm.reset();
        document.getElementById('opportunityId').value = '';
        adminTypeMultiSelect.clear();
        adminFieldMultiSelect.setSelected(['any']); // Default to "any" field
        
        // Set default format to show location field
        handleFormatChange();
    }
    
    adminModal.style.display = 'flex';
}

// Handle check duplicate button click
async function handleCheckDuplicate() {
    const opportunityData = gatherFormData();
    
    if (!opportunityData.title || !opportunityData.organization) {
        showNotification('Please fill in at least the title and organization fields', 'warning');
        return;
    }
    
    const duplicateCheck = await checkForDuplicateOpportunity(opportunityData);
    
    if (duplicateCheck.isDuplicate) {
        showNotification(`Possible duplicate found: ${duplicateCheck.reason} (${duplicateCheck.confidence}% match)`, 'warning');
    } else {
        showNotification('No duplicates found. You can safely submit.', 'success');
    }
}

// Gather form data for duplicate checking
function gatherFormData() {
    const format = document.getElementById('adminFormat').value;
    let location = '';
    if (format === 'online') {
        location = 'Online';
    } else {
        location = document.getElementById('adminLocation').value;
    }
    
    return {
        title: document.getElementById('adminTitle').value.trim(),
        organization: document.getElementById('adminOrganization').value.trim(),
        type: adminTypeMultiSelect.getSelected(),
        field: adminFieldMultiSelect.getSelected(),
        format: format,
        description: document.getElementById('adminDescription').value.trim(),
        location: location,
        deadline: document.getElementById('adminDeadline').value,
        applyLink: document.getElementById('adminApplyLink').value.trim(),
        timeCommitment: document.getElementById('adminTimeCommitment').value,
        duration: document.getElementById('adminDuration').value,
        language: document.getElementById('adminLanguage').value,
        ageRestrictions: document.getElementById('adminAgeRestrictions').value
    };
}

// Handle admin form submission with duplicate checking
async function handleAdminFormSubmit(e) {
    e.preventDefault();
    
    // Check if user is admin
    const user = auth.currentUser;
    if (!user || !isAdminUser) {
        showNotification('Admin privileges required.', 'error');
        return;
    }
    
    const opportunityId = document.getElementById('opportunityId').value;
    const opportunityData = gatherFormData();
    
    // Add user info to opportunity data
    opportunityData.addedBy = user.uid;
    opportunityData.addedByName = user.displayName || user.email;
    opportunityData.createdAt = opportunityId ? allOpportunities.find(opp => opp.id === opportunityId).createdAt : new Date().toISOString();
    opportunityData.updatedAt = new Date().toISOString();
    
    // Skip duplicate check for edits (unless title/org/link changed significantly)
    if (!opportunityId) {
        const duplicateCheck = await checkForDuplicateOpportunity(opportunityData);
        
        if (duplicateCheck.isDuplicate) {
            showDuplicateWarning(duplicateCheck, opportunityData);
            return; // Stop submission
        }
    }
    
    // Proceed with save/update
    saveOpportunityData(opportunityId, opportunityData);
}

// Close admin modal
function closeAdminModal() {
    if (adminModal) {
        adminModal.style.display = 'none';
    }
}

// Delete opportunity
function deleteOpportunity(opportunityId) {
    // Check if user is admin
    const user = auth.currentUser;
    if (!user) {
        showNotification('Please sign in to access admin features', 'warning');
        return;
    }
    
    if (!isAdminUser) {
        showNotification('Access denied. Admin privileges required.', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to delete this opportunity?')) {
        remove(ref(database, `opportunities/${opportunityId}`))
            .then(() => {
                showNotification('Opportunity deleted successfully!');
            })
            .catch((error) => {
                showNotification('Error deleting opportunity: ' + error.message, 'error');
            });
    }
}

// Initialize the app
function initApp() {
    loadOpportunitiesFromFirebase();
    
    // Initialize notification manager
    notificationManager = new NotificationManager();
    
    // Clean up expired notification markers
    if (notificationManager) {
        notificationManager.cleanupExpiredMarkers();
    }
}

// Initialize the app
initApp();
});

// ... (rest of the code)
</script>
</body>
</html>
